<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="嗨，我是曹建波（@jeanboy），一名来自中国的 Android / iOS / 前端 开发者。现居北京，专注于移动应用开发，热爱分享。">
    

    <!--Author-->
    
        <meta name="author" content="曹建波（@jeanboy）">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="一篇文章看明白 Android PackageManagerService 工作流程"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="嗨，我是曹建波（@jeanboy），一名来自中国的 Android / iOS / 前端 开发者。现居北京，专注于移动应用开发，热爱分享。" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Jeanboy | 曹建波"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>一篇文章看明白 Android PackageManagerService 工作流程 - Jeanboy | 曹建波</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Analytics -->
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-121861403-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-121861403-1');
    </script>
    
    
    <!-- Baidu Analytics -->
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?63e553d8293bc74f1160b044738c6107";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
    <!-- google-site-verification -->
    <meta name="google-site-verification" content="R8TtKySmf9yNtEuFKXO0c3YwtVbtTjJU6jWQrzlsxDM" />
    <!-- baidu-site-verification -->
    <meta name="baidu-site-verification" content="T8pesQWGrJ" />

</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 ph5-ns ph3 text-light">
    
    <nav class="db dt-l w-100 mw8 center border-box pv3">
        <a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="Jeanboy | 曹建波">
            <img src="http://www.codeblocq.com/assets/projects/hexo-theme-anodyne/assets/anodyne.svg" class="dib h3" alt="Jeanboy | 曹建波">
        </a>
        <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/" 
                    title="首页">
                    首页
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/archives" 
                    title="归档">
                    归档
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/tags" 
                    title="标签">
                    标签
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/categories" 
                    title="分类">
                    分类
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/about" 
                    title="关于我">
                    关于我
                </a>
            
        </div>
    </nav>

    <!-- Title -->
    <div class="w-100 mw8 center vh-40 dt">
        <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns">一篇文章看明白 Android PackageManagerService 工作流程</h1>
            <p class="f4 fw3 pab-100px tc tc-m tl-ns">2018-07-17</p>
        </div>
    </div>

    <!-- Icon -->
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon fa fa fa-android"></i>
    </div>
</div>

    <!-- Content -->
    <div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
        <div class="content">
            <div class="mw8 center">
                <div class="cf">
                    <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                        <!-- Tags Vertical -->
                        
                            <div class="tags-container-vertical">
                                <div class="tags-sub-container">
                                    <a class="fw3 ph1 dib" href="/tags/Android/">#Android</a> <a class="fw3 ph1 dib" href="/tags/源码分析/">#源码分析</a> <a class="fw3 ph1 dib" href="/tags/PackageMangerService/">#PackageMangerService</a> <a class="fw3 ph1 dib" href="/tags/PKMS/">#PKMS</a> <a class="fw3 ph1 dib" href="/tags/工作流程/">#工作流程</a>
                                </div>
                            </div>
                            

                                <!-- Main Post Content -->
                                <h1 id="Android-PackageMangerService-分析"><a href="#Android-PackageMangerService-分析" class="headerlink" title="Android - PackageMangerService 分析"></a>Android - PackageMangerService 分析</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>PackageManagerService（简称 PKMS），是 Android 系统中核心服务之一，管理着所有跟 package 相关的工作，常见的比如安装、卸载应用。</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_boot_loader/android-bootloader.png?raw=true" alt=""></p>
<p>PackageManagerService 是在 SystemServer 进程中启动的。如不了解 Android 是如何从开机到 Launcher 启动的过程，请先阅读：<a href="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/android/Android-系统启动过程.md" target="_blank" rel="noopener">Android - 系统启动过程</a>。</p>
<h2 id="PackageManagerService-启动"><a href="#PackageManagerService-启动" class="headerlink" title="PackageManagerService 启动"></a>PackageManagerService 启动</h2><p>SystemServer 启动过程中涉及到的 PKMS 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//启动installer服务</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处于加密状态则仅仅解析核心应用</span></span><br><span class="line">    String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>; <span class="comment">// ENCRYPTING_STATE = "trigger_restart_min_framework"</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>; <span class="comment">// ENCRYPTED_STATE = "1"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 PKMS 对象【1】</span></span><br><span class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    <span class="comment">//PKMS是否首次启动</span></span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】</span></span><br><span class="line">    mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//启动 MountService，后续 PackageManager 会需要使用</span></span><br><span class="line">    mSystemServiceManager.startService(MOUNT_SERVICE_CLASS);</span><br><span class="line">    <span class="comment">//【3】做 dex 优化。dex 是 Android 上针对 Java 字节码的一种优化技术，可提高运行效率</span></span><br><span class="line">    mPackageManagerService.performBootDexOpt();</span><br><span class="line">    /...  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// phase 500</span></span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_SYSTEM_SERVICES_READY);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】</span></span><br><span class="line">    mPackageManagerService.systemReady();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个 system_server 进程启动过程，涉及 PKMS 服务的主要几个动作如下，接下来分别讲解每个过程：</p>
<ul>
<li>PKMS.main()</li>
<li>PKMS.performBootDexOpt()</li>
<li>PKMS.systemReady()</li>
</ul>
<h3 id="PKMS-main"><a href="#PKMS-main" class="headerlink" title="PKMS.main()"></a>PKMS.main()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer, </span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化 PKMS 对象</span></span><br><span class="line">    PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">            factoryTest, onlyCore);</span><br><span class="line">    <span class="comment">//将 package 服务注册到 ServiceManager，这是 binder 服务的常规注册流程</span></span><br><span class="line">    ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法的主要功能创建 PKMS 对象，并将其注册到 <code>ServiceManager</code> 中，内部是一个 HashMap 的集合，存储了很多相关的 <code>binder</code> 服务，缓存起来，我们在使用的时候， 会通过 <code>getService(key)</code> 的方式去 <code>map</code>中获取，ServiceManger 工作流程详见：<a href="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/android/Android-Binder%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF.md" target="_blank" rel="noopener">Android - Binder 机制</a>。</p>
<p>关于 PKMS 对象的构造方法很长，分为以下几个阶段，每个阶段会输出相应的 EventLog。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer, </span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//PackageManagerService 启动开始</span></span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START, SystemClock.uptimeMillis());</span><br><span class="line">    <span class="comment">//SDK 版本检查</span></span><br><span class="line">    <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取开机启动模式</span></span><br><span class="line">    String mode = SystemProperties.get(<span class="string">"ro.bootmode"</span>, <span class="string">"mode"</span>);</span><br><span class="line">    engModeEnable = <span class="string">"engtest"</span>.equals(mode) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    Slog.i(TAG, <span class="string">"engModeEnable: "</span> + engModeEnable + <span class="string">" ,mode:"</span> + mode);</span><br><span class="line">    mContext = context;</span><br><span class="line">    mFactoryTest = factoryTest;<span class="comment">//开机模式</span></span><br><span class="line">    mOnlyCore = onlyCore;<span class="comment">//是否对包做 dex 优化</span></span><br><span class="line">    <span class="comment">//如果编译版本为 eng，则不需要 dex 优化</span></span><br><span class="line">    mNoDexOpt = <span class="string">"eng"</span>.equals(SystemProperties.get(<span class="string">"ro.build.type"</span>));</span><br><span class="line">    <span class="comment">//创建显示尺寸信息</span></span><br><span class="line">    mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">    <span class="comment">//存储系统运行过程中的设置信息</span></span><br><span class="line">    mSettings = <span class="keyword">new</span> Settings();<span class="comment">//【1】</span></span><br><span class="line">    <span class="comment">/*创建 SharedUserSetting 对象并添加到 Settings 的成员变量 mSharedUsers 中，</span></span><br><span class="line"><span class="comment">        在 Android 系统中，多个 package 通过设置 sharedUserId 属性可以运行在同一个进程，共享同一个 UID */</span></span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID, ApplicationInfo.FLAG_SYSTEM);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID, ApplicationInfo.FLAG_SYSTEM);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID, ApplicationInfo.FLAG_SYSTEM);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID, ApplicationInfo.FLAG_SYSTEM);</span><br><span class="line">    String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</span><br><span class="line">    <span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</span><br><span class="line">            mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">            mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">            mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</span><br><span class="line">            Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></span><br><span class="line">                   + separateProcesses);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">        mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPreInstallDir = <span class="keyword">new</span> File(<span class="string">"/system/preloadapp"</span>);</span><br><span class="line">    <span class="comment">//创建应用安装器</span></span><br><span class="line">    mInstaller = <span class="keyword">new</span> Installer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取屏幕尺寸大小</span></span><br><span class="line">    WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">    Display d = wm.getDefaultDisplay();</span><br><span class="line">    d.getMetrics(mMetrics);</span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        <span class="comment">// writer</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">//启动消息处理线程</span></span><br><span class="line">            mHandlerThread.start();</span><br><span class="line">            <span class="comment">//为消息处理线程创建一个消息分发handler</span></span><br><span class="line">            mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">            <span class="comment">// dataDir =/data/</span></span><br><span class="line">            File dataDir = Environment.getDataDirectory();</span><br><span class="line">            <span class="comment">// mAppDataDir = /data/data</span></span><br><span class="line">            mAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"data"</span>);</span><br><span class="line">            <span class="comment">// mAsecInternalPath = /data/app-asec</span></span><br><span class="line">            mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</span><br><span class="line">            <span class="comment">// mUserAppDataDir = /data/user</span></span><br><span class="line">            mUserAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"user"</span>);</span><br><span class="line">            <span class="comment">// mDrmAppPrivateInstallDir = /data/app-private</span></span><br><span class="line">            mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</span><br><span class="line">            sUserManager = <span class="keyword">new</span> UserManager(mInstaller, mUserAppDataDir);</span><br><span class="line">            <span class="comment">//读取并解析/etc/permissions下的XML文件</span></span><br><span class="line">            readPermissions();</span><br><span class="line">            mRestoredSettings = mSettings.readLPw();</span><br><span class="line">           	<span class="keyword">long</span> startTime = SystemClock.uptimeMillis();<span class="comment">//【2】</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Runtime.getRuntime().gc();</span><br><span class="line">    <span class="comment">//暴露私有服务，用于系统组件的使用</span></span><br><span class="line">    LocalServices.addService(PackageManagerInternal.class, </span><br><span class="line">		<span class="keyword">new</span> PackageManagerInternalImpl());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刚进入构造函数，就会遇到第一个较为复杂的数据结构 <code>Settings</code> 及它的 <code>addSharedUserLPw()</code> 函数。Settings 的作用是管理 Android 系统运行过程中的一些设置信息。到底是哪些信息呢？来看下面的分析。</p>
<h3 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h3><p>先分析 addSharedUserLPw 函数。如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>,<span class="comment">//字符串</span></span><br><span class="line">    Process.SYSTEM_UID, <span class="comment">//系统进程使用的用户id，值为1000</span></span><br><span class="line">    ApplicationInfo.FLAG_SYSTEM<span class="comment">//标志系统 Package</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>在进入对addSharedUserLPw 函数的分析前，先介绍一下 SYSTEM_UID 及相关知识。</p>
<p>Android 系统中 UID/GID 介绍：</p>
<p>UID 为用户 ID 的缩写，GID 为用户组 ID 的缩写，这两个概念均与 Linux 系统中进程的权限管理有关。一般说来，每一个进程都会有一个对应的 UID（即表示该进程属于哪个 user，不同 user 有不同权限）。一个进程也可分属不同的用户组（每个用户组都有对应的权限）。</p>
<blockquote>
<p>提示 Linux 的 UID/GID 还可细分为几种类型，此处我们仅考虑普适意义的 UID/GID。</p>
</blockquote>
<p>下面分析 addSharedUserLPw 函数，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        注意这里的参数：name 为字符串”android.uid.system”，uid 为 1000，pkgFlags 为</span></span><br><span class="line"><span class="comment">        ApplicationInfo.FLAG_SYSETM (以后简写为FLAG_SYSTEM)</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="comment">//mSharedUsers 是一个 HashMap，key 为字符串，值为 SharedUserSetting 对象</span></span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个新的 SharedUserSettings 对象，并设置的 userId 为 uid</span></span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        mSharedUsers.put(name, s);<span class="comment">//将name与s键值对添加到mSharedUsers中保存</span></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码可知，Settings 中有一个 mSharedUsers 成员，该成员存储的是字符串与 SharedUserSetting 键值对，也就是说以字符串为 key 得到对应的 SharedUserSetting 对象。</p>
<p>那么 SharedUserSettings 是什么？它的目的是什么？来看一个例子。</p>
<p>该例子来源于 SystemUI 的 AndroidManifest.xml，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifestxmlns:android="http:</span>//<span class="attr">schemas.android.com</span>/<span class="attr">apk</span>/<span class="attr">res</span>/<span class="attr">android</span>"</span></span><br><span class="line"><span class="tag">       <span class="attr">package</span>=<span class="string">"com.android.systemui"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">coreApp</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:sharedUserId</span>=<span class="string">"android.uid.system"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:process</span>=<span class="string">"system"</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>在 xml 中，声明了一个名为 <code>android:sharedUserId</code> 的属性，其值为 <code>android.uid.system</code>。 sharedUserId 看起来和 UID 有关，确实如此，它有两个作用：</p>
<ul>
<li>两个或多个声明了同一种 sharedUserIds 的 APK 可共享彼此的数据，并且可运行在同一进程中。</li>
<li>更重要的是，通过声明特定的 sharedUserId，该 APK 所在进程将被赋予指定的 UID。例如，本例中的 SystemUI 声明了 system 的 uid，运行 SystemUI 的进程就可享有 system 用户所对应的权限（实际上就是将该进程的 uid 设置为 system 的 uid）了。</li>
</ul>
<blockquote>
<p>提示：除了在 AndroidManifest.xml 中声明 sharedUserId 外，Apk 在编译时还必须使用对应的证书进行签名。例如，本例的 SystemUI，在其 Android.mk 中需要额外声明 LOCAL_CERTIFICATE := platform，如此，才可获得指定的 UID。</p>
</blockquote>
<p>通过以上介绍，我们能了解到如何组织一种数据结构来包括上面的内容。此处有三个关键点需注意：</p>
<ul>
<li>XML 中 sharedUserId 属性指定了一个字符串，它是 UID 的字符串描述，故对应数据结构中也应该有这样一个字符串，这样就把代码和 XML 中的属性联系起来了。</li>
<li>在 Linux 系统中，真正的 UID 是一个整数，所以该数据结构中必然有一个整型变量。</li>
<li>多个 Package 可声明同一个 sharedUserId，因此该数据结构必然会保存那些声明了相同 sharedUserId的 Package 的某些信息。</li>
</ul>
<p>了解了上面三个关键点，再来看 Android 是如何设计相应数据结构的，如图所示。</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/01.png?raw=true" alt=""></p>
<p>由上图可知：</p>
<ul>
<li>Settings 类定义了一个 mSharedUsers 成员，它是一个 HashMap，以字符串（如“android.uid.system”）为Key，对应的 Value 是一个 SharedUserSettings 对象。</li>
<li>SharedUserSetting 派生自 GrantedPermissions 类，从 GrantedPermissions 类的命名可知，它和权限有关。SharedUserSetting 定义了一个成员变量 packages，类型为 HashSet，用于保存声明了相同 sharedUserId 的 Package 的权限设置信息。</li>
<li>每个 Package 有自己的权限设置。权限的概念由 PackageSetting 类表达。该类继承自 PackagesettingBase，而 PackageSettingBase 又继承自 GrantedPermissions。</li>
<li>Settings 中还有两个成员，一个是 mUserIds，另一个是 mOtherUserIds，这两位成员的类型分别是 ArrayList 和 SparseArray。其目的是以 UID 为索引，得到对应的 SharedUserSettings 对象。在一般情况下，以索引获取数组元素的速度，比以 key 获取 HashMap 中元素的速度要快很多。</li>
</ul>
<blockquote>
<p>提示：根据以上对 mUserIds 和 mOtherUserIds 的描述，可知这是典型的以空间换时间的做法。</p>
</blockquote>
<p>下边来分析 addUserIdLPw 函数，它的功能就是将 SharedUserSettings 对象保存到对应的数组中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Objectname)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//uid 不能超出限制。Android 对 UID 进行了分类，应用 APK 所在进程的 UID 从 10000 开始，</span></span><br><span class="line">    <span class="comment">//而系统 APK 所在进程小于 10000</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= PackageManagerService.FIRST_APPLICATION_UID + PackageManagerService.MAX_APPLICATION_UIDS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= PackageManagerService.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="comment">//计算索引，其值是 uid 和 FIRST_APPLICATION_UID 的差</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - PackageManagerService.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</span><br><span class="line">            mUserIds.add(<span class="keyword">null</span>);</span><br><span class="line">            N++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">//判断该索引位置的内容是否为空，为空才保存</span></span><br><span class="line">        mUserIds.set(index, obj);<span class="comment">//mUserIds 保存应用 Package 的 UID</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        mOtherUserIds.put(uid, obj);<span class="comment">//系统 Package 的 UID 由 mOtherUserIds 保存</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="readPermissions"><a href="#readPermissions" class="headerlink" title="readPermissions()"></a>readPermissions()</h3><p>先来分析 readPermissions 函数，从其函数名可猜测到它和权限有关，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermissions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 指向 /system/etc/permission 目录，该目录中存储了和设备相关的一些权限信息</span></span><br><span class="line">    FilelibraryDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"etc/permissions"</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">for</span> (File f : libraryDir.listFiles()) &#123;</span><br><span class="line">        <span class="comment">//先处理该目录下的非platform.xml文件</span></span><br><span class="line">        <span class="keyword">if</span> (f.getPath().endsWith(<span class="string">"etc/permissions/platform.xml"</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">// 调用 readPermissionFromXml 解析此 XML 文件</span></span><br><span class="line">        readPermissionsFromXml(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    finalFile permFile = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"etc/permissions/platform.xml"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析 platform.xml 文件，看来该文件优先级最高</span></span><br><span class="line">    readPermissionsFromXml(permFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>etc/permissions</code> 目录下保存了一下配置文件：</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/02.png?raw=true" alt=""></p>
<p>函数 readPermissionsFromXml 使用 PULL 方式解析这些 XML 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsFromXml</span><span class="params">(File permFile)</span> </span>&#123;</span><br><span class="line">    FileReader permReader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permReader = <span class="keyword">new</span> FileReader(permFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(permReader);</span><br><span class="line">        XmlUtils.beginDocument(parser, <span class="string">"permissions"</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            String name = parser.getName();</span><br><span class="line">            <span class="comment">//解析 group 标签，前面介绍的 XML 文件中没有单独使用该标签的地方</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"group"</span>.equals(name)) &#123;</span><br><span class="line">                String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">                <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> gid = Integer.parseInt(gidStr);</span><br><span class="line">                    <span class="comment">//转换 XML 中的 gi d字符串为整型，并保存到 mGlobalGids 中</span></span><br><span class="line">                    mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"permission"</span>.equals(name)) &#123;<span class="comment">//解析 permission 标签</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                <span class="comment">//调用 readPermission 处理</span></span><br><span class="line">                readPermission(parser, perm);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"assign-permission"</span>.equals(name)) &#123;<span class="comment">//下面解析的是assign-permission标签</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                String uidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                <span class="comment">//如果是 assign-permission，则取出 uid 字符串，然后获得 Linux 平台上</span></span><br><span class="line">                <span class="comment">//的整型 uid 值</span></span><br><span class="line">                <span class="keyword">int</span> uid = Process.getUidForName(uidStr);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                <span class="comment">//和 assign 相关的信息保存在 mSystemPermissions 中</span></span><br><span class="line">                HashSet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">                <span class="keyword">if</span> (perms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    perms = newHashSet &lt; String &gt; ();</span><br><span class="line">                    mSystemPermissions.put(uid, perms);</span><br><span class="line">                &#125;</span><br><span class="line">                perms.add(perm);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"library"</span>.equals(name)) &#123;<span class="comment">//解析 library 标签</span></span><br><span class="line">                String lname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                String lfile = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"file"</span>);</span><br><span class="line">                <span class="keyword">if</span> (lname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//将 XML 中的 name 和 library 属性值存储到 mSharedLibraries 中</span></span><br><span class="line">                    mSharedLibraries.put(lname, lfile);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"feature"</span>.equals(name)) &#123;<span class="comment">//解析 feature 标签</span></span><br><span class="line">                String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//在 XML 中定义的 feature 由 FeatureInfo 表达</span></span><br><span class="line">                    FeatureInfo fi = newFeatureInfo();</span><br><span class="line">                    fi.name = fname;</span><br><span class="line">                    <span class="comment">//存储 feature 名和对应的 FeatureInfo 到 mAvailableFeatures 中</span></span><br><span class="line">                    mAvailableFeatures.put(fname, fi);</span><br><span class="line">                &#125;<span class="comment">//...</span></span><br><span class="line">            &#125; <span class="comment">//...</span></span><br><span class="line">        &#125; <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>readPermissions 函数就是将 XML 中的标签转换成对应的数据结构。</p>
<h3 id="readLPw"><a href="#readLPw" class="headerlink" title="readLPw()"></a>readLPw()</h3><p>readLPw 函数的功能也是解析文件，不过这些文件的内容却是在 PKMS 正常启动后生成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Settings() &#123;</span><br><span class="line">    FiledataDir = Environment.getDataDirectory();</span><br><span class="line">    FilesystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);<span class="comment">//指向/data/system目录</span></span><br><span class="line">    systemDir.mkdirs();<span class="comment">//创建该目录</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        一共有 5 个文件，packages.xml 和 packages-backup.xml 为一组，用于描述系统中</span></span><br><span class="line"><span class="comment">        所安装的 Package 的信息，其中 backup 是临时文件。PKMS 先把数据写到 backup 中，</span></span><br><span class="line"><span class="comment">        信息都写成功后再改名成非 backup 的文件。其目的是防止在写文件过程中出错，导致信息丢失。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        packages-stopped.xml 和 packages-stopped-backup.xml 为一组，用于描述系统中</span></span><br><span class="line"><span class="comment">        强制停止运行的 pakcage 的信息，backup 也是临时文件。如果此处存在该临时文件，表明</span></span><br><span class="line"><span class="comment">        此前系统因为某种原因中断了正常流程 packages.list 列出当前系统中应用级（即UID大于10000）Package 的信息</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(systemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(systemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(systemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(systemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(systemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面 5 个文件共分为三组，这里简单介绍一下这些文件的来历（不考虑临时的 backup 文件）。</p>
<ul>
<li>packages.xml： PKMS 扫描完目标文件夹后会创建该文件。当系统进行程序安装、卸载和更新等操作时，均会更新该文件。该文件保存了系统中与 package 相关的一些信息。</li>
<li>packages.list：描述系统中存在的所有非系统自带的 APK 的信息。当这些程序有变动时，PKMS 就会更新该文件。</li>
<li>packages-stopped.xml：从系统自带的设置程序中进入应用程序页面，然后在选择强制停止（ForceStop）某个应用时，系统会将该应用的相关信息记录到此文件中。也就是该文件保存系统中被用户强制停止的 Package 的信息。</li>
</ul>
<p>readLPw 的函数功能就是解析其中的 XML 文件的内容，然后建立并更新对应的数据结构。例如，停止的 package 重启之后依然是 stopped 状态。</p>
<h3 id="第一阶段总结"><a href="#第一阶段总结" class="headerlink" title="第一阶段总结"></a>第一阶段总结</h3><p>PKMS 构造函数在第一阶段的工作，主要是扫描并解析 XML 文件，将其中的信息保存到特定的数据结构中。</p>
<p>第一阶段扫描的 XML 文件与权限及上一次扫描得到的 Package 信息有关，它为 PKMS 下一阶段的工作提供了重要的参考信息。</p>
<h3 id="扫描-Package"><a href="#扫描-Package" class="headerlink" title="扫描 Package"></a>扫描 Package</h3><p>PKMS 构造函数第二阶段的工作就是扫描系统中的 APK 了。由于需要逐个扫描文件，因此手机上装的程序越多，PKMS 的工作量越大，系统启动速度也就越慢。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">mRestoredSettings = mSettings.readLPw();<span class="comment">//接第一段的结尾</span></span><br><span class="line">longstartTime = SystemClock.uptimeMillis();<span class="comment">//记录扫描开始的时间</span></span><br><span class="line"><span class="comment">//定义扫描参数</span></span><br><span class="line">intscanMode = SCAN_MONITOR | SCAN_NO_PATHS | SCAN_DEFER_DEX;</span><br><span class="line"><span class="keyword">if</span> (mNoDexOpt) &#123;</span><br><span class="line">    scanMode |= SCAN_NO_DEX; <span class="comment">//在控制扫描过程中是否对 APK 文件进行 dex 优化</span></span><br><span class="line">&#125;</span><br><span class="line">finalHashSet&lt;String&gt; libFiles = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line"><span class="comment">// mFrameworkDir指向/system/frameworks目录</span></span><br><span class="line">mFrameworkDir = newFile(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"><span class="comment">// mDalvikCacheDir指向/data/dalvik-cache目录</span></span><br><span class="line">mDalvikCacheDir = <span class="keyword">new</span> File(dataDir, <span class="string">"dalvik-cache"</span>);</span><br><span class="line">booleandidDexOpt = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  获取 Java 启动类库的路径，在 init.rc 文件中通过 BOOTCLASSPATH 环境变量输出，该值如下</span></span><br><span class="line"><span class="comment">  /system/framework/core.jar:/system/frameworks/core-junit.jar:</span></span><br><span class="line"><span class="comment">  /system/frameworks/bouncycastle.jar:/system/frameworks/ext.jar:</span></span><br><span class="line"><span class="comment">  /system/frameworks/framework.jar:/system/frameworks/android.policy.jar:</span></span><br><span class="line"><span class="comment">  /system/frameworks/services.jar:/system/frameworks/apache-xml.jar:</span></span><br><span class="line"><span class="comment">  /system/frameworks/filterfw.jar</span></span><br><span class="line"><span class="comment">  该变量指明了 framework 所有核心库及文件位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">StringbootClassPath = System.getProperty(<span class="string">"java.boot.class.path"</span>);</span><br><span class="line"><span class="keyword">if</span> (bootClassPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String[] paths = splitString(bootClassPath, <span class="string">':'</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paths.length; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;  <span class="comment">//判断该 jar 包是否需要重新做 dex 优化</span></span><br><span class="line">            <span class="keyword">if</span> (dalvik.system.DexFile.isDexOptNeeded(paths[i])) &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               将该 jar 包文件路径保存到 libFiles 中，然后通过 mInstall 对象发送</span></span><br><span class="line"><span class="comment">               命令给 installd，让其对该 jar 包进行 dex 优化</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">                libFiles.add(paths[i]);</span><br><span class="line">                mInstaller.dexopt(paths[i], Process.SYSTEM_UID, <span class="keyword">true</span>);</span><br><span class="line">                didDexOpt = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">还记得 mSharedLibrarires 的作用吗？它保存的是 platform.xml 中声明的系统库的信息。</span></span><br><span class="line"><span class="comment">这里也要判断系统库是否需要做 dex 优化。处理方式同上</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将 framework-res.apk 添加到 libFiles 中。framework-res.apk 定义了系统常用的</span></span><br><span class="line"><span class="comment">//资源，还有几个重要的 Activity，如长按 Power 键后弹出的选择框</span></span><br><span class="line">libFiles.add(mFrameworkDir.getPath() + <span class="string">"/framework-res.apk"</span>);</span><br><span class="line"><span class="comment">//列举 /system/frameworks 目录中的文件</span></span><br><span class="line">String[] frameworkFiles = mFrameworkDir.list();</span><br><span class="line"><span class="keyword">if</span> (frameworkFiles != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// 判断该目录下的 apk 或 jar 文件是否需要做 dex 优化。处理方式同上</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">上面代码对系统库（BOOTCLASSPATH 指定，或 platform.xml 定义，或</span></span><br><span class="line"><span class="comment">/system/frameworks目录下的 jar 包与 apk 文件）进行一次仔细检查，该优化的一定要优化。</span></span><br><span class="line"><span class="comment">如果发现期间对任何一个文件进行了优化，则设置 didDexOpt 为 true</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (didDexOpt) &#123;</span><br><span class="line">    String[] files = mDalvikCacheDir.list();</span><br><span class="line">    <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果前面对任意一个系统库重新做过 dex 优化，就需要删除 cache 文件。原因和</span></span><br><span class="line"><span class="comment">        dalvik 虚拟机的运行机制有关。暂不探讨 dex 及 cache 文件的作用。</span></span><br><span class="line"><span class="comment">        从删除 cache 文件这个操作来看，这些 cache 文件应该使用了 dex 优化后的系统库</span></span><br><span class="line"><span class="comment">        所以当系统库重新做 dex 优化后，就需要删除旧的 cache 文件。可简单理解为缓存失效</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">            String fn = files[i];</span><br><span class="line">            <span class="keyword">if</span> (fn.startsWith(<span class="string">"data@app@"</span>) || fn.startsWith(<span class="string">"data@app-private@"</span>)) &#123;</span><br><span class="line">                (newFile(mDalvikCacheDir, fn)).delete();</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清空 cache 文件后，PKMS 终于进入重点段了。接下来看 PKMS 第二阶段工作的核心内容，即扫描 Package。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建文件夹监控对象，监视 /system/frameworks 目录。利用了 Linux 平台的 notify 机制</span></span><br><span class="line">mFrameworkInstallObserver = <span class="keyword">new</span> AppDirObserver(mFrameworkDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</span><br><span class="line">mFrameworkInstallObserver.startWatching();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 调用 scanDirLI 函数扫描 /system/frameworks 目录，这个函数很重要，稍后会再分析。</span></span><br><span class="line"><span class="comment"> 注意，在第三个参数中设置了SCAN_NO_DEX标志，因为该目录下的package在前面的流程</span></span><br><span class="line"><span class="comment"> 中已经过判断并根据需要做过dex优化了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">scanDirLI(mFrameworkDir, PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanMode | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//创建文件夹监控对象，监视 /system/app 目录</span></span><br><span class="line">mSystemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">mSystemInstallObserver = <span class="keyword">new</span> AppDirObserver(mSystemAppDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</span><br><span class="line">mSystemInstallObserver.startWatching();</span><br><span class="line"></span><br><span class="line"><span class="comment">//扫描 /system/app 下的 package</span></span><br><span class="line">scanDirLI(mSystemAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanMode, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//监视并扫描 /vendor/app 目录</span></span><br><span class="line">mVendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line">mVendorInstallObserver = <span class="keyword">new</span> AppDirObserver(mVendorAppDir.getPath(), OBSERVER_EVENTS, <span class="keyword">true</span>);</span><br><span class="line">mVendorInstallObserver.startWatching();</span><br><span class="line"></span><br><span class="line"><span class="comment">//扫描 /vendor/app 下的 package</span></span><br><span class="line">scanDirLI(mVendorAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanMode, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//和 installd 交互。以后单独分析 installd</span></span><br><span class="line">mInstaller.moveFiles();</span><br></pre></td></tr></table></figure>
<p>由以上代码可知，PKMS 将扫描以下几个目录。</p>
<ul>
<li>/system/frameworks：该目录中的文件都是系统库，例如：framework.jar、services.jar、framework-res.apk。不过 scanDirLI 只扫描APK文件，所以 framework-res.apk 是该目录中唯一“受宠”的文件。</li>
<li>/system/app：该目录下全是默认的系统应用，例如：Browser.apk、SettingsProvider.apk 等。</li>
<li>/vendor/app：该目录中的文件由厂商提供，即厂商特定的 APK 文件，不过目前市面上的厂商都把自己的应用放在 /system/app 目录下。</li>
</ul>
<p>PKMS 调用 scanDirLI 函数进行扫描，下面来分析此函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> flags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    String[] files = dir.list();<span class="comment">//列举该目录下的文件</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir, files[i]);</span><br><span class="line">        <span class="keyword">if</span> (!isPackageFilename(files[i])) &#123;</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">//根据文件名后缀，判断是否为APK 文件。这里只扫描APK 文件</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            调用scanPackageLI函数扫描一个特定的文件，返回值是PackageParser的内部类</span></span><br><span class="line"><span class="comment">            Package，该类的实例代表一个APK文件，所以它就是和APK文件对应的数据结构</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        PackageParser.Package pkg = scanPackageLI(file,</span><br><span class="line">                                                  flags | PackageParser.PARSE_MUST_BE_APK, scanMode, currentTime);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span> &amp;&amp; (flags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            mLastScanError == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</span><br><span class="line">            <span class="comment">//注意此处flags的作用，只有非系统Package扫描失败，才会删除该文件</span></span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着来分析 scanPackageLI 函数。PKMS 中有两个同名的 scanPackageLI 函数，后面会一一见到。先来看第一个也是最先碰到的 scanPackageLI 函数。</p>
<h3 id="scanPackageLI"><a href="#scanPackageLI" class="headerlink" title="scanPackageLI()"></a>scanPackageLI()</h3><p>首次相遇的 scanPackageLI 函数的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(FilescanFile, <span class="keyword">int</span> parseFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    mLastScanError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    StringscanPath = scanFile.getPath();</span><br><span class="line">    parseFlags |= mDefParseFlags;<span class="comment">//默认的扫描标志，正常情况下为0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个 PackageParser 对象</span></span><br><span class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser(scanPath);</span><br><span class="line">    pp.setSeparateProcesses(mSeparateProcesses);<span class="comment">// mSeparateProcesses 为空</span></span><br><span class="line">    pp.setOnlyCoreApps(mOnlyCore);<span class="comment">// mOnlyCore 为 false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">           调用 PackageParser 的 parsePackage 函数解析APK文件。注意，这里把代表屏幕</span></span><br><span class="line"><span class="comment">           信息的 mMetrics 对象也传了进去</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    finalPackageParser.Package pkg = pp.parsePackage(scanFile,</span><br><span class="line">                                                     scanPath, mMetrics, parseFlags);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting updatedPkg;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">            这里略去一大段代码，主要是关于 Package 升级方面的工作。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="comment">//收集签名信息，这部分内容涉及 signature。</span></span><br><span class="line">    <span class="keyword">if</span> (!collectCertificatesLI(pp, ps, pkg, scanFile, parseFlags))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否需要设置 PARSE_FORWARD_LOCK 标志，这个标志针对资源文件和 Class 文件</span></span><br><span class="line">    <span class="comment">//不在同一个目录的情况。目前只有 /vendor/app 目录下的扫描会使用该标志。这里不讨论</span></span><br><span class="line">    <span class="comment">//这种情况。</span></span><br><span class="line">    <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath))</span><br><span class="line">        parseFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line"></span><br><span class="line">    String codePath = <span class="keyword">null</span>;</span><br><span class="line">    String resPath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//...//这里不考虑 PARSE_FORWARD_LOCK的情况。</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resPath = pkg.mScanPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    codePath = pkg.mScanPath;<span class="comment">//mScanPath 指向该 APK 文件所在位置</span></span><br><span class="line">    <span class="comment">//设置文件路径信息，codePath 和 resPath 都指向 APK 文件所在位置</span></span><br><span class="line">    setApplicationInfoPaths(pkg, codePath, resPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用第二个 scanPackageLI 函数</span></span><br><span class="line">    <span class="keyword">return</span> scanPackageLI(pkg, parseFlags, scanMode | SCAN_UPDATE_SIGNATURE,</span><br><span class="line">                         currentTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scanPackageLI 函数首先调用 PackageParser 对 APK 文件进行解析。根据前面的介绍可知，PackageParser 完成了从物理文件到对应数据结构的转换。下面来分析这个 PackageParser。</p>
<h3 id="PackageParser"><a href="#PackageParser" class="headerlink" title="PackageParser"></a>PackageParser</h3><p>PackageParser 主要负责 APK 文件的解析，即解析 APK 文件中的 AndroidManifest.xml 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File sourceFile, String destCodePath,</span></span></span><br><span class="line"><span class="function"><span class="params">                                DisplayMetrics metrics, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = sourceFile.getPath();</span><br><span class="line">    <span class="comment">//...//检查是否为 APK 文件</span></span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line">    AssetManager assmgr = <span class="keyword">null</span>;</span><br><span class="line">    Resources res = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> assetError = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        assmgr = <span class="keyword">new</span> AssetManager();</span><br><span class="line">        <span class="keyword">int</span> cookie = assmgr.addAssetPath(mArchiveSourcePath);</span><br><span class="line">        <span class="keyword">if</span> (cookie != <span class="number">0</span>) &#123;</span><br><span class="line">            res = <span class="keyword">new</span> Resources(assmgr, metrics, <span class="keyword">null</span>);</span><br><span class="line">            assmgr.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                    <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">              获得一个 XML 资源解析对象，该对象解析的是 APK 中的 AndroidManifest.xml 文件。</span></span><br><span class="line"><span class="comment">              以后再讨论 AssetManager、Resource 及相关的知识</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            parser = assmgr.openXmlResourceParser(cookie,</span><br><span class="line">                                                  ANDROID_MANIFEST_FILENAME);</span><br><span class="line">            assetError = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="comment">//...//出错处理</span></span><br><span class="line">        String[] errorText = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        Package pkg = <span class="keyword">null</span>;</span><br><span class="line">        Exception errorException = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//调用另外一个 parsePackage 函数</span></span><br><span class="line">            pkg = parsePackage(res, parser, flags, errorText);</span><br><span class="line">        &#125;<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//...//错误处理</span></span><br><span class="line">        parser.close();</span><br><span class="line">        assmgr.close();</span><br><span class="line">        <span class="comment">//保存文件路径，都指向 APK 文件所在的路径</span></span><br><span class="line">        pkg.mPath = destCodePath;</span><br><span class="line">        pkg.mScanPath = mArchiveSourcePath;</span><br><span class="line">        pkg.mSignatures = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码中调用了另一个同名的 parsePackage 函数，此函数内容较长，但功能单一，就是解析 AndroidManifest.xml 中的各种标签，这里只提取其中相关的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parsePackage</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    AttributeSet attrs = parser;</span><br><span class="line">    mParseInstrumentationArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseActivityArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseServiceArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseProviderArgs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//得到 Package 的名字，其实就是得到 AndroidManifest.xml 中 package 属性的值，</span></span><br><span class="line">    <span class="comment">//每个 APK 都必须定义该属性</span></span><br><span class="line">    String pkgName = parsePackageName(parser, attrs, flags, outError);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//以 pkgName 名字为参数，创建一个 Package 对象。后面的工作就是解析 XML 并填充</span></span><br><span class="line">    <span class="comment">//该 Package 信息</span></span><br><span class="line">    <span class="keyword">final</span> Package pkg = <span class="keyword">new</span> Package(pkgName);</span><br><span class="line">    <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//...//下面开始解析该文件中的标签，由于这段代码功能简单，所以这里仅列举相关函数</span></span><br><span class="line">    <span class="keyword">while</span> (如果解析未完成) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        StringtagName = parser.getName(); <span class="comment">//得到标签名</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">            <span class="comment">//...//解析 application 标签</span></span><br><span class="line">            parseApplication(pkg, res, parser, attrs, flags, outError);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-group"</span>)) &#123;</span><br><span class="line">            <span class="comment">//...//解析 permission-group 标签</span></span><br><span class="line">            parsePermissionGroup(pkg, res, parser, attrs, outError);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">//...//解析 permission 标签</span></span><br><span class="line">            parsePermission(pkg, res, parser, attrs, outError);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">//从 XML 文件中获取 uses-permission 标签的属性</span></span><br><span class="line">            sa = res.obtainAttributes(attrs,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesPermission);</span><br><span class="line">            <span class="comment">//取出属性值，也就是对应的权限使用声明</span></span><br><span class="line">            String name = sa.getNonResourceString(com.android.internal.</span><br><span class="line">                    R.styleable.AndroidManifestUsesPermission_name);</span><br><span class="line">            <span class="comment">//添加到 Package 的 requestedPermissions 数组</span></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; !pkg.requestedPermissions.contains(name)) &#123;</span><br><span class="line">                pkg.requestedPermissions.add(name.intern());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-configuration"</span>)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                该标签用于指明本 package 对硬件的一些设置参数，目前主要针对输入设备（触摸屏、键盘</span></span><br><span class="line"><span class="comment">                等）。游戏类的应用可能对此有特殊要求。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            ConfigurationInfocPref = <span class="keyword">new</span> ConfigurationInfo();</span><br><span class="line">            <span class="comment">//...//解析该标签所支持的各种属性</span></span><br><span class="line">            pkg.configPreferences.add(cPref);<span class="comment">//保存到 Package 的 configPreferences 数组</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...//对其他标签解析和处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码展示了 AndroidManifest.xml 解析的流程，其中比较重要的函数是 parserApplication，它用于解析 application 标签及其子标签（Android 的四大组件在 application 标签中已声明）。</p>
<p>PackageParser 及其内部重要成员的信息。</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/03.png?raw=true" alt=""></p>
<ul>
<li>PackageParser 定了相当多的内部类，这些内部类的作用就是保存对应的信息。解析 AndroidManifest.xml 文件得到的信息由 Package 保存。从该类的成员变量可看出，和 Android 四大组件相关的信息分别由 activites、receivers、providers、services 保存。由于一个 APK 可声明多个组件，因此 activites 和 receiver s等均声明为 ArrayList。</li>
<li>以 PackageParser.Activity 为例，它从 Component<activityintentinfo> 派生。Component 是一个模板类，元素类型是 ActivityIntentInfo，此类的顶层基类是 IntentFilter。PackageParser.Activity 内部有一个 ActivityInfo 类型的成员变量，该变量保存的就是四大组件中 Activity 的信息。细心的读者可能会有疑问，为什么不直接使用 ActivityInfo，而是通过 IntentFilter 构造出一个使用模板的复杂类型 PackageParser.Activity 呢？原来，Package 除了保存信息外，还需要支持 Intent 匹配查询。例如，设置 Intent 的 Action 为某个特定值，然后查找匹配该 Intent 的 Activity。由于 ActivityIntentInfo 是从 IntentFilter 派生的，因此它它能判断自己是否满足该 Intent 的要求，如果满足，则返回对应的 ActivityInfo。</activityintentinfo></li>
<li>PackageParser 定了一个轻量级的数据结构 PackageLite，该类仅存储 Package 的一些简单信息。我们在介绍 Package 安装的时候，会遇到  PackageLite。</li>
</ul>
<p>在 PackageParser 扫描完一个 APK 后，此时系统已经根据该 APK 中 AndroidManifest.xml，创建了一个完整的 Package 对象，下一步就是将该 Package 加入到系统中。此时调用的函数就是另外一个 scanPackageLI，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.PackagescanPackageLI(</span><br><span class="line">    PackageParser.Package pkg, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanMode, <span class="keyword">long</span> currentTime) &#123;</span><br><span class="line">    FilescanFile = <span class="keyword">new</span> File(pkg.mScanPath);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    mScanningPath = scanFile;</span><br><span class="line">    <span class="comment">//设置 package 对象中 applicationInfo 的 flags 标签，用于标示该 Package 为系统</span></span><br><span class="line">    <span class="comment">//Package</span></span><br><span class="line">    <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面这句 if 判断极为重要，见下面的解释</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAndroidApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">                mPlatformPackage = pkg;</span><br><span class="line">                pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                mAndroidApplication = pkg.applicationInfo;</span><br><span class="line">                mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                mResolveActivity.processName = mAndroidApplication.processName;</span><br><span class="line">                mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                mResolveActivity.theme = com.android.internal.R.style.Theme_Holo_Dialog_Alert;</span><br><span class="line">                mResolveActivity.exported = <span class="keyword">true</span>;</span><br><span class="line">                mResolveActivity.enabled = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//mResoveInfo 的 activityInfo 成员指向 mResolveActivity</span></span><br><span class="line">                mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                mResolveComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                        mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刚进入 scanPackageLI 函数，我们就发现了一个极为重要的内容，即单独判断并处理 packageName 为 <code>android</code> 的 Package。和该 Package 对应的APK是 framework-res.apk，有图为证。</p>
<p>framework-res.apk 的 AndroidManifest.xml：</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/04.png?raw=true" alt=""></p>
<p>实际上，framework-res.apk 还包含了以下几个常用的 Activity。</p>
<ul>
<li>ChooserActivity：当多个 Activity 符合某个 Intent 的时候，系统会弹出此 Activity，由用户选择合适的应用来处理。</li>
<li>RingtonePickerActivity：铃声选择 Activity。</li>
<li>ShutdownActivity：关机前弹出的选择对话框。</li>
</ul>
<p>由前述知识可知，该 Package 和系统息息相关，因此它得到了 PKMS 的特别青睐，主要体现在以下几点。</p>
<ul>
<li>mPlatformPackage 成员用于保存该 Package 信息。</li>
<li>mAndroidApplication 用于保存此 Package 中的 ApplicationInfo。</li>
<li>mResolveActivity 指向用于表示 ChooserActivity 信息的 ActivityInfo。</li>
<li>mResolveInfo 为 ResolveInfo 类型，它用于存储系统解析 Intent（经 IntentFilter 的过滤）后得到的结果信息，例如：满足某个 Intent 的 Activity 的信息。由前面的代码可知，mResolveInfo 的 activityInfo 其实指向的就是 mResolveActivity。</li>
</ul>
<blockquote>
<p>注意：在从 PKMS 中查询满足某个 Intent 的 Activity 时，返回的就是 ResolveInfo，再根据 ResolveInfo 的信息得到具体的 Activity。</p>
</blockquote>
<p>此处保存这些信息，主要是为了提高运行过程中的效率。Goolge工 程师可能觉得 ChooserActivity 使用的地方比较多，所以这里单独保存了此 Activity 的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...//mPackages 用于保存系统内的所有 Package，以 packageName 为 key</span></span><br><span class="line"><span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">        || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">File destCodeFile = newFile(pkg.applicationInfo.sourceDir);</span><br><span class="line">FiledestResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.publicSourceDir);</span><br><span class="line">SharedUserSettingsuid = <span class="keyword">null</span>;<span class="comment">//代表该 Package 的 SharedUserSetting 对象</span></span><br><span class="line">PackageSetting pkgSetting = <span class="keyword">null</span>;<span class="comment">//代表该 Package 的 PackageSetting 对象</span></span><br><span class="line"><span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    <span class="comment">//...//此段代码大约有300行左右，主要做了以下几方面工作</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      1. 如果该 Package 声明了”uses-libraries” 话，那么系统要判断该 library 是否在 mSharedLibraries 中</span></span><br><span class="line"><span class="comment">      2. 如果 package 声明了 SharedUser，则需要处理 SharedUserSettings 相关内容，由 Settings 的 getSharedUserLPw 函数处理</span></span><br><span class="line"><span class="comment">      3. 处理 pkgSetting，通过调用 Settings 的 getPackageLPw 函数完成</span></span><br><span class="line"><span class="comment">      4. 调用 verifySignaturesLP 函数，检查该 Package 的 signature</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = scanFile.lastModified();</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> forceDex = (scanMode &amp; SCAN_FORCE_DEX) != <span class="number">0</span>;</span><br><span class="line"><span class="comment">//确定运行该 package 的进程的进程名，一般用 packageName 作为进程名</span></span><br><span class="line">pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">        pkg.applicationInfo.packageName,</span><br><span class="line">        pkg.applicationInfo.processName,</span><br><span class="line">        pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">    dataPath = <span class="keyword">new</span> File(Environment.getDataDirectory(), <span class="string">"system"</span>);</span><br><span class="line">    pkg.applicationInfo.dataDir = dataPath.getPath();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     getDataPathForPackage 函数返回该 package 的目录，一般是 /data/data/packageName/</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    dataPath = getDataPathForPackage(pkg.packageName, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (dataPath.exists()) &#123;</span><br><span class="line">        <span class="comment">//...//如果该目录已经存在，则要处理 uid 的问题</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//...//向 installd 发送 install 命令，实际上就是在 /data/data 下</span></span><br><span class="line">        <span class="comment">//建立 packageName 目录。后续将分析 installd 相关知识</span></span><br><span class="line">        <span class="keyword">int</span> ret = mInstaller.install(pkgName, pkg.applicationInfo.uid,</span><br><span class="line">                pkg.applicationInfo.uid);</span><br><span class="line">        <span class="comment">//为系统所有 user 安装此程序</span></span><br><span class="line">        mUserManager.installPackageForAllUsers(pkgName,</span><br><span class="line">                pkg.applicationInfo.uid);</span><br><span class="line">        <span class="keyword">if</span> (dataPath.exists()) &#123;</span><br><span class="line">            pkg.applicationInfo.dataDir = dataPath.getPath();</span><br><span class="line">        &#125; <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.nativeLibraryDir == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                pkg.applicationInfo.dataDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//...//为该 Package 确定 native library 所在目录</span></span><br><span class="line">            <span class="comment">//一般是 /data/data/packagename/lib</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果该 APK 包含了 native 动态库，则需要将它们从 APK 文件中解压并复制到对应目录中</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.nativeLibraryDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> File nativeLibraryDir = <span class="keyword">new</span></span><br><span class="line">                    File(pkg.applicationInfo.nativeLibraryDir);</span><br><span class="line">            <span class="keyword">final</span> String dataPathString = dataPath.getCanonicalPath();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从 2.3 开始，系统 package 的 native 库统一放在 /system/lib 下。所以</span></span><br><span class="line">            <span class="comment">//系统不会提取系统 Package 目录下 APK 包中的 native 库</span></span><br><span class="line">            <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp; !isUpdatedSystemApp(pkg)) &#123;</span><br><span class="line">                NativeLibraryHelper.removeNativeBinariesFromDirLI(</span><br><span class="line">                        nativeLibraryDir))&#123;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nativeLibraryDir.getParentFile().getCanonicalPath()</span><br><span class="line">                        .equals(dataPathString)) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> isSymLink;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        isSymLink = S_ISLNK(Libcore.os.lstat(</span><br><span class="line">                                nativeLibraryDir.getPath()).st_mode);</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="comment">//...//判断是否为链接，如果是，需要删除该链接</span></span><br><span class="line">                    <span class="keyword">if</span> (isSymLink) &#123;</span><br><span class="line">                        mInstaller.unlinkNativeLibraryDirectory(dataPathString);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//在 lib 下建立和 CPU 类型对应的目录，例如 ARM 平台的是 arm/，MIPS 平台的是 mips/</span></span><br><span class="line">                    NativeLibraryHelper.copyNativeBinariesIfNeededLI(scanFile,</span><br><span class="line">                            nativeLibraryDir);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstaller.linkNativeLibraryDirectory(dataPathString,</span><br><span class="line">                            pkg.applicationInfo.nativeLibraryDir);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        pkg.mScanPath = path;</span><br><span class="line">        <span class="keyword">if</span> ((scanMode &amp; SCAN_NO_DEX) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//...//对该 APK 做 dex 优化</span></span><br><span class="line">            performDexOptLI(pkg, forceDex, (scanMode &amp; SCAN_DEFER_DEX);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果该 APK 已经存在，要先杀掉运行该 APK 的进程</span></span><br><span class="line">        <span class="keyword">if</span> ((parseFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">            killApplication(pkg.applicationInfo.packageName,</span><br><span class="line">                    pkg.applicationInfo.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         在此之前，四大组件信息都属于 Package 的私有财产，现在需要把它们登记注册到 PKMS 内部的</span></span><br><span class="line"><span class="comment">         财产管理对象中。这样，PKMS 就可对外提供统一的组件信息，而不必拘泥于具体的 Package</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((scanMode &amp; SCAN_MONITOR) != <span class="number">0</span>) &#123;</span><br><span class="line">                mAppDirs.put(pkg.mPath, pkg);</span><br><span class="line">            &#125;</span><br><span class="line">            mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">            mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">            <span class="comment">//处理该 Package 中的 Provider 信息</span></span><br><span class="line">            <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                PackageParser.Providerp = pkg.providers.get(i);</span><br><span class="line">                p.info.processName = fixProcessName(</span><br><span class="line">                        pkg.applicationInfo.processName,</span><br><span class="line">                        p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                <span class="comment">//mProvidersByComponent 提供基于 ComponentName 的 Provider 信息查询</span></span><br><span class="line">                mProvidersByComponent.put(<span class="keyword">new</span> ComponentName(</span><br><span class="line">                        <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理该 Package 中的 Service 信息</span></span><br><span class="line">            N = pkg.services.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">                mServices.addService(s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理该 Package 中的 BroadcastReceiver 信息</span></span><br><span class="line">            N = pkg.receivers.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">                mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理该 Package 中的 Activity 信息</span></span><br><span class="line">            N = pkg.activities.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">                mActivities.addActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理该 Package 中的 PermissionGroups 信息</span></span><br><span class="line">            N = pkg.permissionGroups.size();</span><br><span class="line">            <span class="comment">//...//permissionGroups 处理</span></span><br><span class="line">            N = pkg.permissions.size();</span><br><span class="line">            <span class="comment">//...//permissions 处理</span></span><br><span class="line">            N = pkg.instrumentation.size();</span><br><span class="line">            <span class="comment">//...//instrumentation 处理</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                N = pkg.protectedBroadcasts.size();</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//...//Package 的私有财产终于完成了公有化改造</span></span><br><span class="line">            <span class="keyword">return</span> pkg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scanPackageLI() 总结</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/05.png?raw=true" alt=""></p>
<p>扫描非系统 Package，非系统 Package 就是指那些不存储在系统目录下的 APK 文件，这部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;<span class="comment">//mOnlyCore 用于控制是否扫描非系统 Package</span></span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        <span class="comment">//...//删除系统package中那些不存在的APK</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</span><br><span class="line">    <span class="comment">//...//删除安装不成功的文件及临时文件</span></span><br><span class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">        <span class="comment">//在普通模式下，还需要扫描 /data/app 以及 /data/app_private 目录</span></span><br><span class="line">        mAppInstallObserver = <span class="keyword">new</span> AppDirObserver(</span><br><span class="line">                mAppInstallDir.getPath(), OBSERVER_EVENTS, <span class="keyword">false</span>);</span><br><span class="line">        mAppInstallObserver.startWatching();</span><br><span class="line">        scanDirLI(mAppInstallDir, <span class="number">0</span>, scanMode, <span class="number">0</span>);</span><br><span class="line">        mDrmAppInstallObserver = newAppDirObserver(</span><br><span class="line">                mDrmAppPrivateInstallDir.getPath(), OBSERVER_EVENTS, <span class="keyword">false</span>);</span><br><span class="line">        mDrmAppInstallObserver.startWatching();</span><br><span class="line">        scanDirLI(mDrmAppPrivateInstallDir,</span><br><span class="line">                PackageParser.PARSE_FORWARD_LOCK, scanMode, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mAppInstallObserver = <span class="keyword">null</span>;</span><br><span class="line">        mDrmAppInstallObserver = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合前述代码，这里总结几个存放APK文件的目录。</p>
<ul>
<li>系统 Package 目录包括：/system/frameworks、/system/app 和 /vendor/app。</li>
<li>非系统 Package 目录包括：/data/app、/data/app-private。</li>
</ul>
<h3 id="第二阶段总结"><a href="#第二阶段总结" class="headerlink" title="第二阶段总结"></a>第二阶段总结</h3><p>PKMS 构造函数第二阶段的工作任务非常繁重，要创建比较多的对象，所以它是一个耗时耗内存的操作。在工作中，我们一直想优化该流程以加快启动速度，例如：延时扫描不重要的 APK，或者保存 Package 信息到文件中，然后在启动时从文件中恢复这些信息以减少 APK 文件读取并解析 XML 的工作量。但是一直没有一个比较完满的解决方案，原因有很多。比如：APK 之间有着比较微妙的依赖关系，因此到底延时扫描哪些 APK，尚不能确定。</p>
<h3 id="构造函数扫尾工作"><a href="#构造函数扫尾工作" class="headerlink" title="构造函数扫尾工作"></a>构造函数扫尾工作</h3><p>下面分析 PKMS 第三阶段的工作，这部分任务比较简单，就是将第二阶段收集的信息再集中整理一次，比如将有些信息保存到文件中，相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	mSettings.mInternalSdkPlatform= mSdkVersion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//汇总并更新和 Permission 相关的信息</span></span><br><span class="line">    updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>, regrantPermissions,regrantPermissions);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将信息写到 package.xml、package.list 及 package-stopped.xml 文件中</span></span><br><span class="line">    mSettings.writeLPr();</span><br><span class="line">    Runtime.getRuntime().gc();</span><br><span class="line">    mRequiredVerifierPackage= getRequiredVerifierLPr();</span><br><span class="line">    <span class="comment">//...//PKMS 构造函数返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从流程角度看，PKMS 构造函数的功能还算清晰，无非是扫描 XML 或 APK 文件，但是其中涉及的数据结构及它们之间的关系却较为复杂。这里有一些建议供读者参考：</p>
<ul>
<li>理解 PKMS 构造函数工作的三个阶段及其各阶段的工作职责。</li>
<li>了解 PKMS 第二阶段工作中解析 APK 文件的几个关键步骤。</li>
<li>了解重点数据结构的名字和大体功能。</li>
</ul>
<h3 id="获取-PackageManager-服务"><a href="#获取-PackageManager-服务" class="headerlink" title="获取 PackageManager 服务"></a>获取 PackageManager 服务</h3><p>ContextImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPackageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//见下面分析</span></span><br><span class="line">    IPackageManager pm = ActivityThread.getPackageManager();</span><br><span class="line">    <span class="keyword">if</span> (pm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//创建 ApplicationPackageManager 对象</span></span><br><span class="line">        <span class="keyword">return</span> (mPackageManager = <span class="keyword">new</span> ApplicationPackageManager(<span class="keyword">this</span>, pm));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取 PKMS 服务，并创建 ApplicationPackageManager 对象。</p>
<p>ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IPackageManager <span class="title">getPackageManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sPackageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sPackageManager;</span><br><span class="line">    &#125;</span><br><span class="line">    IBinder b = ServiceManager.getService(<span class="string">"package"</span>);</span><br><span class="line">    sPackageManager = IPackageManager.Stub.asInterface(b);</span><br><span class="line">    <span class="keyword">return</span> sPackageManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与 ServiceManager 通讯获取到 PKMS 的代理对象。</p>
<h3 id="PKMS-performBootDexOpt"><a href="#PKMS-performBootDexOpt" class="headerlink" title="PKMS.performBootDexOpt()"></a>PKMS.performBootDexOpt()</h3><p>PackageManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performBootDexOpt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 确保只有 system 或者 root uid 有权限执行该方法</span></span><br><span class="line">   enforceSystemOrRoot(<span class="string">"Only the system can request dexopt be performed"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//运行在同一个进程,此处拿到的 MountService 的服务端</span></span><br><span class="line">   IMountService ms = PackageHelper.getMountService();</span><br><span class="line">   <span class="keyword">if</span> (ms != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> isUpgrade = isUpgrade(); <span class="comment">//处于更新状态，则执行fstrim</span></span><br><span class="line">       <span class="keyword">boolean</span> doTrim = isUpgrade;</span><br><span class="line">       <span class="keyword">if</span> (doTrim) &#123;</span><br><span class="line">           Slog.w(TAG, <span class="string">"Running disk maintenance immediately due to system update"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//interval 默认值为 3 天</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> interval = android.provider.Settings.Global.getLong(</span><br><span class="line">                   mContext.getContentResolver(),</span><br><span class="line">                   android.provider.Settings.Global.FSTRIM_MANDATORY_INTERVAL,</span><br><span class="line">                   DEFAULT_MANDATORY_FSTRIM_INTERVAL);</span><br><span class="line">           <span class="keyword">if</span> (interval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> timeSinceLast = System.currentTimeMillis() - ms.lastMaintenance();</span><br><span class="line">               <span class="keyword">if</span> (timeSinceLast &gt; interval) &#123;</span><br><span class="line">                   doTrim = <span class="keyword">true</span>; <span class="comment">//距离上次 fstrim 时间超过 3 天，则执行 fstrim</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//此处 ms 是指 MountService，该过程发送消息 H_FSTRIM 给 handler，然后再向 vold 发送 fstrim 命令</span></span><br><span class="line">       <span class="keyword">if</span> (doTrim) &#123;</span><br><span class="line">           ms.runMaintenance();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ArraySet&lt;PackageParser.Package&gt; pkgs;</span><br><span class="line">   <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">       <span class="comment">//清空延迟执行 dexopt 操作的 app，获取 dexopt 操作的 app 集合</span></span><br><span class="line">       pkgs = mPackageDexOptimizer.clearDeferredDexOptPackages();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (pkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">       ArrayList&lt;PackageParser.Package&gt; sortedPkgs = <span class="keyword">new</span> ArrayList&lt;PackageParser.Package&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (Iterator&lt;PackageParser.Package&gt; it = pkgs.iterator(); it.hasNext();) &#123;</span><br><span class="line">           PackageParser.Package pkg = it.next();</span><br><span class="line">           <span class="comment">//将 pkgs 中的核心 app 添加到 sortedPkgs</span></span><br><span class="line">           <span class="keyword">if</span> (pkg.coreApp) &#123;</span><br><span class="line">               sortedPkgs.add(pkg);</span><br><span class="line">               it.remove();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//获取监听 PRE_BOOT_COMPLETE 的系统 app 集合</span></span><br><span class="line">       Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PRE_BOOT_COMPLETED);</span><br><span class="line">       ArraySet&lt;String&gt; pkgNames = getPackageNamesForIntent(intent);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (Iterator&lt;PackageParser.Package&gt; it = pkgs.iterator(); it.hasNext();) &#123;</span><br><span class="line">           PackageParser.Package pkg = it.next();</span><br><span class="line">           <span class="comment">//将 pkg 中监听 PRE_BOOT_COMPLETE 的 app 添加到 sortedPkgs</span></span><br><span class="line">           <span class="keyword">if</span> (pkgNames.contains(pkg.packageName)) &#123;</span><br><span class="line">               sortedPkgs.add(pkg);</span><br><span class="line">               it.remove();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//获取 pkgs 中最近一周使用过的 app，详见下面</span></span><br><span class="line">       filterRecentlyUsedApps(pkgs);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//将最近一周的 app 添加到 sortedPkgs</span></span><br><span class="line">       <span class="keyword">for</span> (PackageParser.Package pkg : pkgs) &#123;</span><br><span class="line">           sortedPkgs.add(pkg);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mLazyDexOpt) &#123;</span><br><span class="line">           filterRecentlyUsedApps(sortedPkgs);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> total = sortedPkgs.size();</span><br><span class="line">       File dataDir = Environment.getDataDirectory();</span><br><span class="line">       <span class="keyword">long</span> lowThreshold = StorageManager.from(mContext).getStorageLowBytes(dataDir);</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (PackageParser.Package pkg : sortedPkgs) &#123;</span><br><span class="line">           <span class="keyword">long</span> usableSpace = dataDir.getUsableSpace();</span><br><span class="line">           <span class="keyword">if</span> (usableSpace &lt; lowThreshold) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//详见下面</span></span><br><span class="line">           performBootDexOpt(pkg, ++i, total);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">filterRecentlyUsedApps</span><span class="params">(Collection&lt;PackageParser.Package&gt; pkgs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mLazyDexOpt || (!isFirstBoot() &amp;&amp; mPackageUsage.isHistoricalPackageUsageAvailable())) &#123;</span><br><span class="line">         <span class="keyword">int</span> total = pkgs.size();</span><br><span class="line">         <span class="keyword">int</span> skipped = <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">         <span class="keyword">for</span> (Iterator&lt;PackageParser.Package&gt; i = pkgs.iterator(); i.hasNext();) &#123;</span><br><span class="line">             PackageParser.Package pkg = i.next();</span><br><span class="line">             <span class="comment">// 过滤出最近使用过的 app</span></span><br><span class="line">             <span class="keyword">long</span> then = pkg.mLastPackageUsageTimeInMills;</span><br><span class="line">             <span class="keyword">if</span> (then + mDexOptLRUThresholdInMills &lt; now) &#123;</span><br><span class="line">                 i.remove();</span><br><span class="line">                 skipped++;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performBootDexOpt</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> curr, <span class="keyword">int</span> total)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFirstBoot()) &#123;</span><br><span class="line">        ActivityManagerNative.getDefault().showBootMessage(</span><br><span class="line">              mContext.getResources().getString(R.string.android_upgrading_apk,</span><br><span class="line">                  curr, total), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PackageParser.Package p = pkg;</span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        mPackageDexOptimizer.performDexOpt(p, <span class="keyword">null</span> <span class="comment">/* instruction sets */</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* force dex */</span>, <span class="keyword">false</span> <span class="comment">/* defer */</span>, <span class="keyword">true</span> <span class="comment">/* include dependencies */</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* boot complete */</span>, <span class="keyword">false</span> <span class="comment">/*useJit*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PKMS-systemReady"><a href="#PKMS-systemReady" class="headerlink" title="PKMS.systemReady()"></a>PKMS.systemReady()</h3><p>PackageManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        ArrayList&lt;PreferredActivity&gt; removed = <span class="keyword">new</span> ArrayList&lt;PreferredActivity&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mSettings.mPreferredActivities.size(); i++) &#123;</span><br><span class="line">            PreferredIntentResolver pir = mSettings.mPreferredActivities.valueAt(i);</span><br><span class="line">            removed.clear();</span><br><span class="line">            <span class="keyword">for</span> (PreferredActivity pa : pir.filterSet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mActivities.mActivities.get(pa.mPref.mComponent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    removed.add(pa);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (removed.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;removed.size(); r++) &#123;</span><br><span class="line">                    PreferredActivity pa = removed.get(r);</span><br><span class="line">                    pir.removeFilter(pa);</span><br><span class="line">                &#125;</span><br><span class="line">                mSettings.writePackageRestrictionsLPr(</span><br><span class="line">                        mSettings.mPreferredActivities.keyAt(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettings.areDefaultRuntimePermissionsGrantedLPr(userId)) &#123;</span><br><span class="line">                grantPermissionsUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        grantPermissionsUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sUserManager.systemReady(); <span class="comment">//多用户服务</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//升级所有已获取的默认权限</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : grantPermissionsUserIds) &#123;</span><br><span class="line">        mDefaultPermissionPolicy.grantDefaultPermissions(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理所有等待系统准备就绪的消息</span></span><br><span class="line">    <span class="keyword">if</span> (mPostSystemReadyMessages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message msg : mPostSystemReadyMessages) &#123;</span><br><span class="line">            msg.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">        mPostSystemReadyMessages = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//观察外部存储设备</span></span><br><span class="line">    <span class="keyword">final</span> StorageManager storage = mContext.getSystemService(StorageManager.class);</span><br><span class="line">    storage.registerListener(mStorageListener);</span><br><span class="line"></span><br><span class="line">    mInstallerService.systemReady();</span><br><span class="line">    mPackageDexOptimizer.systemReady();</span><br><span class="line"></span><br><span class="line">    MountServiceInternal mountServiceInternal = LocalServices.getService(MountServiceInternal.class);</span><br><span class="line">    mountServiceInternal.addExternalStoragePolicy(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageManagerService 启动完整流程图：</p>
<p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/07.png?raw=true" alt=""></p>
<h2 id="installd"><a href="#installd" class="headerlink" title="installd"></a>installd</h2><p>PackageManagerServie 服务负责应用的安装、卸载等相关工作，而真正干活的还是 installd。 其中 PKMS 执行权限为 system，而进程 installd 的执行权限为 root。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>installd 是由 Android 系统的 init 进程(pid=1)，在解析 init.rc 文件的如下代码块时，通过 fork 创建的用户空间的守护进程 installd。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service installd /system/bin/installd</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">installd</span> <span class="title">stream</span> 600 <span class="title">system</span> <span class="title">system</span></span></span><br></pre></td></tr></table></figure>
<p>installd 是随着系统启动过程中 main class 而启动的，并且会创建一个 socket 套接字，用于跟上层的 PKMS 进行交互。 installd 的启动入口 frameworks/base/cmds/installd/installd.c 的 main() 方法，接下来从这里开始说起。</p>
<p>installd.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> argc __unused, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFFER_MAX]; <span class="comment">//buffer大小为1024Byte</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> alen;</span><br><span class="line">    <span class="keyword">int</span> lsocket, s;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化全局信息【1】</span></span><br><span class="line">    <span class="keyword">if</span> (initialize_globals() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化相关目录【2】</span></span><br><span class="line">    <span class="keyword">if</span> (initialize_directories() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取套接字"installd"</span></span><br><span class="line">    lsocket = android_get_control_socket(SOCKET_PATH);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (listen(lsocket, <span class="number">5</span>)) &#123; <span class="comment">//监听socket消息</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fcntl(lsocket, F_SETFD, FD_CLOEXEC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">        s = accept(lsocket, &amp;addr, &amp;alen); <span class="comment">//接受socket消息</span></span><br><span class="line">        <span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fcntl(s, F_SETFD, FD_CLOEXEC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">short</span> count;</span><br><span class="line">            <span class="comment">//读取指令的长度</span></span><br><span class="line">            <span class="keyword">if</span> (readx(s, &amp;count, <span class="keyword">sizeof</span>(count))) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((count &lt; <span class="number">1</span>) || (count &gt;= BUFFER_MAX)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//读取指令的内容</span></span><br><span class="line">            <span class="keyword">if</span> (readx(s, buf, count)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buf[count] = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="comment">//执行指令【3】</span></span><br><span class="line">            <span class="keyword">if</span> (execute(s, buf)) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>installd.cpp -&gt; initialize_globals</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">initialize_globals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 数据目录/data/</span></span><br><span class="line">    <span class="keyword">if</span> (get_path_from_env(&amp;android_data_dir, <span class="string">"ANDROID_DATA"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// app目录/data/app/</span></span><br><span class="line">    <span class="keyword">if</span> (copy_and_append(&amp;android_app_dir, &amp;android_data_dir, APP_SUBDIR) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 受保护的app目录/data/priv-app/</span></span><br><span class="line">    <span class="keyword">if</span> (copy_and_append(&amp;android_app_private_dir, &amp;android_data_dir, PRIVATE_APP_SUBDIR) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// app本地库目录/data/app-lib/</span></span><br><span class="line">    <span class="keyword">if</span> (copy_and_append(&amp;android_app_lib_dir, &amp;android_data_dir, APP_LIB_SUBDIR) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sdcard挂载点/mnt/asec</span></span><br><span class="line">    <span class="keyword">if</span> (get_path_from_env(&amp;android_asec_dir, <span class="string">"ASEC_MOUNTPOINT"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多媒体目录/data/media</span></span><br><span class="line">    <span class="keyword">if</span> (copy_and_append(&amp;android_media_dir, &amp;android_data_dir, MEDIA_SUBDIR) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 外部app目录/mnt/expand</span></span><br><span class="line">    <span class="keyword">if</span> (get_path_from_string(&amp;android_mnt_expand_dir, <span class="string">"/mnt/expand/"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统和厂商目录</span></span><br><span class="line">    android_system_dirs.count = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    android_system_dirs.dirs = (<span class="keyword">dir_rec_t</span>*) <span class="built_in">calloc</span>(android_system_dirs.count, <span class="keyword">sizeof</span>(<span class="keyword">dir_rec_t</span>));</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">dir_rec_t</span> android_root_dir;</span><br><span class="line">    <span class="comment">// 目录/system</span></span><br><span class="line">    <span class="keyword">if</span> (get_path_from_env(&amp;android_root_dir, <span class="string">"ANDROID_ROOT"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目录/system/app</span></span><br><span class="line">    android_system_dirs.dirs[<span class="number">0</span>].path = build_string2(android_root_dir.path, APP_SUBDIR);</span><br><span class="line">    android_system_dirs.dirs[<span class="number">0</span>].len = <span class="built_in">strlen</span>(android_system_dirs.dirs[<span class="number">0</span>].path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 目录/system/app-lib</span></span><br><span class="line">    android_system_dirs.dirs[<span class="number">1</span>].path = build_string2(android_root_dir.path, PRIV_APP_SUBDIR);</span><br><span class="line">    android_system_dirs.dirs[<span class="number">1</span>].len = <span class="built_in">strlen</span>(android_system_dirs.dirs[<span class="number">1</span>].path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目录/vendor/app/</span></span><br><span class="line">    android_system_dirs.dirs[<span class="number">2</span>].path = strdup(<span class="string">"/vendor/app/"</span>);</span><br><span class="line">    android_system_dirs.dirs[<span class="number">2</span>].len = <span class="built_in">strlen</span>(android_system_dirs.dirs[<span class="number">2</span>].path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目录/oem/app/</span></span><br><span class="line">    android_system_dirs.dirs[<span class="number">3</span>].path = strdup(<span class="string">"/oem/app/"</span>);</span><br><span class="line">    android_system_dirs.dirs[<span class="number">3</span>].len = <span class="built_in">strlen</span>(android_system_dirs.dirs[<span class="number">3</span>].path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>installd.cpp -&gt; initialize_directories</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">initialize_directories</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取当前文件系统版本</span></span><br><span class="line">    <span class="keyword">char</span> version_path[PATH_MAX];</span><br><span class="line">    <span class="built_in">snprintf</span>(version_path, PATH_MAX, <span class="string">"%s.layout_version"</span>, android_data_dir.path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldVersion;</span><br><span class="line">    <span class="keyword">if</span> (fs_read_atomic_int(version_path, &amp;oldVersion) == <span class="number">-1</span>) &#123;</span><br><span class="line">        oldVersion = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> version = oldVersion;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目录/data/user</span></span><br><span class="line">    <span class="keyword">char</span> *user_data_dir = build_string2(android_data_dir.path, SECONDARY_USER_PREFIX);</span><br><span class="line">    <span class="comment">// 目录/data/data</span></span><br><span class="line">    <span class="keyword">char</span> *legacy_data_dir = build_string2(android_data_dir.path, PRIMARY_USER_PREFIX);</span><br><span class="line">    <span class="comment">// 目录/data/user/0</span></span><br><span class="line">    <span class="keyword">char</span> *primary_data_dir = build_string3(android_data_dir.path, SECONDARY_USER_PREFIX, <span class="string">"0"</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//将/data/user/0链接到/data/data</span></span><br><span class="line">    <span class="keyword">if</span> (access(primary_data_dir, R_OK) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (symlink(legacy_data_dir, primary_data_dir)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//... //处理data/media 相关</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>installd.cpp -&gt; execute</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">execute</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">char</span> cmd[BUFFER_MAX])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> reply[REPLY_MAX];</span><br><span class="line">    <span class="keyword">char</span> *arg[TOKEN_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> count;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    reply[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    arg[<span class="number">0</span>] = cmd;</span><br><span class="line">    <span class="keyword">while</span> (*cmd) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isspace</span>(*cmd)) &#123;</span><br><span class="line">            *cmd++ = <span class="number">0</span>;</span><br><span class="line">            n++;</span><br><span class="line">            arg[n] = cmd;</span><br><span class="line">            <span class="keyword">if</span> (n == TOKEN_MAX) &#123;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*cmd) &#123;</span><br><span class="line">          cmd++; <span class="comment">//计算参数个数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cmds) / <span class="keyword">sizeof</span>(cmds[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmds[i].name,arg[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n != cmds[i].numargs) &#123;</span><br><span class="line">                <span class="comment">//参数个数不匹配，直接返回</span></span><br><span class="line">                ALOGE(<span class="string">"%s requires %d arguments (%d given)\n"</span>,</span><br><span class="line">                    cmds[i].name, cmds[i].numargs, n);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//执行相应的命令[见小节2.5]</span></span><br><span class="line">                ret = cmds[i].func(arg + <span class="number">1</span>, reply);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    <span class="keyword">if</span> (reply[<span class="number">0</span>]) &#123;</span><br><span class="line">        n = <span class="built_in">snprintf</span>(cmd, BUFFER_MAX, <span class="string">"%d %s"</span>, ret, reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n = <span class="built_in">snprintf</span>(cmd, BUFFER_MAX, <span class="string">"%d"</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; BUFFER_MAX) n = BUFFER_MAX;</span><br><span class="line">    count = n;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将命令执行后的返回值写入socket套接字</span></span><br><span class="line">    <span class="keyword">if</span> (writex(s, &amp;count, <span class="keyword">sizeof</span>(count))) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (writex(s, cmd, count)) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Installer"><a href="#Installer" class="headerlink" title="Installer"></a>Installer</h3><p>当守护进程 installd 启动完成后，上层 framework 便可以通过 socket 跟该守护进程进行通信。 在 SystemServer 启动服务的过程中创建 Installer 对象，便会有一次跟 installd 通信的过程。</p>
<p>SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//启动 installer 服务</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Installer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Installer</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    <span class="comment">//创建 InstallerConnection 对象</span></span><br><span class="line">    mInstaller = <span class="keyword">new</span> InstallerConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Slog.i(TAG, <span class="string">"Waiting for installd to be ready."</span>);</span><br><span class="line">  mInstaller.waitForConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先创建 Installer 对象，再调用 onStart() 方法，该方法中主要工作是等待 socket 通道建立完成。</p>
<p>InstallerConnection.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitForConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (execute(<span class="string">"ping"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.w(TAG, <span class="string">"installd not ready"</span>);</span><br><span class="line">        SystemClock.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">execute</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">    String res = transact(cmd);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(res);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException ex) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">transact</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!connect()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"-1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!writeCommand(cmd)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!connect() || !writeCommand(cmd)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"-1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取应答消息</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> replyLength = readReply();</span><br><span class="line">    <span class="keyword">if</span> (replyLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String s = <span class="keyword">new</span> String(buf, <span class="number">0</span>, replyLength);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"-1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.i(TAG, <span class="string">"connecting..."</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mSocket = <span class="keyword">new</span> LocalSocket();</span><br><span class="line"></span><br><span class="line">        LocalSocketAddress address = <span class="keyword">new</span> LocalSocketAddress(<span class="string">"installd"</span>,</span><br><span class="line">                LocalSocketAddress.Namespace.RESERVED);</span><br><span class="line"></span><br><span class="line">        mSocket.connect(address);</span><br><span class="line"></span><br><span class="line">        mIn = mSocket.getInputStream();</span><br><span class="line">        mOut = mSocket.getOutputStream();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        disconnect();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">writeCommand</span><span class="params">(String cmdString)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] cmd = cmdString.getBytes();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> len = cmd.length;</span><br><span class="line">    <span class="keyword">if</span> ((len &lt; <span class="number">1</span>) || (len &gt; buf.length)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = (<span class="keyword">byte</span>) (len &amp; <span class="number">0xff</span>);</span><br><span class="line">    buf[<span class="number">1</span>] = (<span class="keyword">byte</span>) ((len &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mOut.write(buf, <span class="number">0</span>, <span class="number">2</span>); <span class="comment">//写入长度</span></span><br><span class="line">        mOut.write(cmd, <span class="number">0</span>, len); <span class="comment">//写入具体命令</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        disconnect();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">readReply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!readFully(buf, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> len = (((<span class="keyword">int</span>) buf[<span class="number">0</span>]) &amp; <span class="number">0xff</span>) | ((((<span class="keyword">int</span>) buf[<span class="number">1</span>]) &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ((len &lt; <span class="number">1</span>) || (len &gt; buf.length)) &#123;</span><br><span class="line">        disconnect();</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!readFully(buf, len)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">readFully</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         Streams.readFully(mIn, buffer, <span class="number">0</span>, len);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">         disconnect();</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>可见，一次 transact 过程为先 connect() 来判断是否建立 socket 连接，如果已连接则通过 writeCommand() 将命令写入 socket 的 mOut 管道，等待从管道的 mIn 中 readFully() 读取应答消息。</p>
<h2 id="Apk-安装过程分析"><a href="#Apk-安装过程分析" class="headerlink" title="Apk 安装过程分析"></a>Apk 安装过程分析</h2><h3 id="adb-install-分析"><a href="#adb-install-分析" class="headerlink" title="adb install 分析"></a>adb install 分析</h3><p>adb install 有多个参数，这里仅考虑最简单的，如： <code>adb install frameworktest.apk</code>。adb 是一个命令，install 是它的参数。此处直接跳到处理 install 参数的代码：</p>
<p>commandline.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">   	<span class="comment">//... </span></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"install"</span>)) &#123;</span><br><span class="line">       	<span class="comment">//...</span></span><br><span class="line">		<span class="comment">//调用 install_app 函数处理</span></span><br><span class="line">       	<span class="keyword">return</span> install_app(ttype, serial, argc, argv);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">install_app</span><span class="params">(transport_type transport, <span class="keyword">char</span>*serial, <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>&#123;</span><br><span class="line">	<span class="comment">//要安装的APK现在还在Host机器上，要先把APK复制到手机中。</span></span><br><span class="line">   	<span class="comment">//这里需要设置复制目标的目录，如果安装在内部存储中，则目标目录为/data/local/tmp；</span></span><br><span class="line">   	<span class="comment">//如果安装在SD卡上，则目标目录为/sdcard/tmp。</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> DATA_DEST = <span class="string">"/data/local/tmp/%s"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> SD_DEST = <span class="string">"/sdcard/tmp/%s"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* where = DATA_DEST;</span><br><span class="line">    <span class="keyword">char</span> apk_dest[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> verification_dest[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> *apk_file;</span><br><span class="line">    <span class="keyword">char</span> *verification_file = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> file_arg = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> err</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i =<span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(*argv[i] != <span class="string">'-'</span>) &#123;</span><br><span class="line">           file_arg = i</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"-i"</span>)) &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"-s"</span>)) &#123;</span><br><span class="line">           where = SD_DEST; <span class="comment">//-s参数指明该APK安装到SD卡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    apk_file = argv[file_arg];</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//获取目标文件的全路径，如果安装在内部存储中，则目标全路径为/data/local/tmp/安装包名，</span></span><br><span class="line">    <span class="comment">//调用do_sync_push将此APK传送到手机的目标路径</span></span><br><span class="line">    err = do_sync_push(apk_file, apk_dest, <span class="number">1</span> <span class="comment">/* verify APK */</span>);</span><br><span class="line">	<span class="comment">//... </span></span><br><span class="line">    <span class="comment">//执行 pm 命令【1】</span></span><br><span class="line"></span><br><span class="line">    pm_command(transport,serial, argc, argv);</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">  	cleanup_apk:</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在手机中执行shell rm 命令，删除刚才传送过去的目标 Apk 文件</span></span><br><span class="line">  	delete_file(transport, serial, apk_dest);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commandline.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pm_command</span><span class="params">(transport_type transport,<span class="keyword">char</span>* serial,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(buf,<span class="keyword">sizeof</span>(buf), <span class="string">"shell:pm"</span>);</span><br><span class="line">  	<span class="comment">//...</span></span><br><span class="line">  	<span class="comment">//发送"shell:pm install 参数"给手机端的 adbd</span></span><br><span class="line">   	send_shellcommand(transport, serial, buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>手机端的 adbd 在收到客户端发来的 shell:pm 命令时会启动一个 shell，然后在其中执行 pm。</p>
<p>pm 实际上是一个脚本，其内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Script to start <span class="string">"pm"</span> on the device,which has a very rudimentary</span><br><span class="line"><span class="meta"># shell.</span></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">base=/system</span><br><span class="line"><span class="keyword">export</span> CLASSPATH=$base/frameworks/pm.jar</span><br><span class="line">exec app_process $base/bincom.android.commands.pm.Pm <span class="string">"$@"</span></span><br></pre></td></tr></table></figure>
<p>在编译 system.image 时，Android.mk 中会将该脚本复制到 system/bin 目录下。从 pm 脚本的内容来看，它就是通过 app_process 执行 pm.jar 包的 main 函数。</p>
<p>pm.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">new</span> Pm().run(args);<span class="comment">//创建一个 Pm 对象，并执行它的 run 函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//直接分析 run 函数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> validCommand = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//获取PKMS的binder客户端</span></span><br><span class="line">	mPm = IPackageManager.Stub</span><br><span class="line">			.asInterface(ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	mArgs = args;</span><br><span class="line">	String op = args[<span class="number">0</span>];</span><br><span class="line">	mNextArg = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//...//处理其他命令，这里仅考虑 install 的处理</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="string">"install"</span>.equals(op)) &#123;</span><br><span class="line">   		runInstall();</span><br><span class="line">   		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	intinstallFlags = <span class="number">0</span>;</span><br><span class="line">	String installerPackageName = <span class="keyword">null</span>;</span><br><span class="line">	String opt;</span><br><span class="line">	<span class="keyword">while</span> ((opt=nextOption()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">   		<span class="keyword">if</span> (opt.equals(<span class="string">"-l"</span>)) &#123;</span><br><span class="line">       		installFlags |= PackageManager.INSTALL_FORWARD_LOCK;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opt.equals(<span class="string">"-r"</span>)) &#123;</span><br><span class="line">			installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opt.equals(<span class="string">"-i"</span>)) &#123;</span><br><span class="line">			installerPackageName = nextOptionData();</span><br><span class="line">			<span class="comment">//... //参数解析</span></span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> Uri apkURI;</span><br><span class="line">	<span class="keyword">final</span> Uri verificationURI;</span><br><span class="line">	<span class="keyword">final</span> String apkFilePath = nextArg();</span><br><span class="line">	System.err.println(<span class="string">"/tpkg: "</span> + apkFilePath);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(apkFilePath != <span class="keyword">null</span>) &#123;</span><br><span class="line">		apkURI = Uri.fromFile(<span class="keyword">new</span> File(apkFilePath));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">//获取 Verification Package 的文件位置</span></span><br><span class="line">	<span class="keyword">final</span> String verificationFilePath = nextArg();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(verificationFilePath != <span class="keyword">null</span>) &#123;</span><br><span class="line">  		verificationURI = Uri.fromFile(<span class="keyword">new</span> File(verificationFilePath));</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">   		verificationURI = <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建 PackageInstallObserver，用于接收 PKMS 的安装结果</span></span><br><span class="line">	PackageInstallObserver obs = <span class="keyword">new</span> PackageInstallObserver();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">	  	<span class="comment">//调用 PKMS 的 installPackageWithVerification 完成安装</span></span><br><span class="line">	   	mPm.installPackageWithVerification(apkURI, obs,</span><br><span class="line">                          installFlags,installerPackageName,</span><br><span class="line">                          verificationURI,<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">synchronized</span> (obs) &#123;</span><br><span class="line">		<span class="keyword">while</span>(!obs.finished) &#123;</span><br><span class="line">  			<span class="keyword">try</span>&#123;</span><br><span class="line">          		obs.wait();<span class="comment">//等待安装结果</span></span><br><span class="line">     		&#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line"> 		&#125;</span><br><span class="line">	 	<span class="keyword">if</span>(obs.result == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">	    	System.out.println(<span class="string">"Success"</span>);<span class="comment">//安装成功，打印 Success</span></span><br><span class="line">	 	&#125;</span><br><span class="line">		<span class="comment">//...//安装失败，打印失败原因</span></span><br><span class="line">	&#125; </span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pm 解析参数后，最终通过 PKMS 的 Binder 客户端调用 installPackageWithVerification 以完成后续的安装工作，所以，下面进入 PKMS 看看安装到底是怎么一回事。</p>
<h3 id="installPackageWithVerification-分析"><a href="#installPackageWithVerification-分析" class="headerlink" title="installPackageWithVerification 分析"></a>installPackageWithVerification 分析</h3><p>PackageManagerService.java::installPackageWithVerification</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installPackageWithVerification</span><span class="params">(UripackageURI,</span></span></span><br><span class="line"><span class="function"><span class="params">		IPackageInstallObserverobserver,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">int</span> flags, String installerPackageName, Uri verificationURI,</span></span></span><br><span class="line"><span class="function"><span class="params">		ManifestDigest manifestDigest)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查客户端进程是否具有安装 Package 的权限。在本例中，该客户端进程是 shell</span></span><br><span class="line">	mContext.enforceCallingOrSelfPermission(</span><br><span class="line">	android.Manifest.permission.INSTALL_PACKAGES,null);</span><br><span class="line">	final <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">	final <span class="keyword">int</span> filteredFlags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(uid == Process.SHELL_UID || uid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//...//如果通过 shell pm 的方式安装，则增加 INSTALL_FROM_ADB 标志</span></span><br><span class="line">		filteredFlags = flags | PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		filteredFlags = flags &amp; ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建一个 Message，code 为 INIT_COPY，将该消息发送给之前在 PKMS 构造函数中</span></span><br><span class="line">	<span class="comment">//创建的 mHandler 对象，将在另外一个工作线程中处理此消息</span></span><br><span class="line">	final Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建一个 InstallParams，其基类是 HandlerParams</span></span><br><span class="line">	msg.obj = <span class="keyword">new</span> InstallParams(packageURI, observer,</span><br><span class="line">	filteredFlags,installerPackageName,</span><br><span class="line">	verificationURI,manifestDigest);</span><br><span class="line">	mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="INIT-COPY-处理"><a href="#INIT-COPY-处理" class="headerlink" title="INIT_COPY 处理"></a>INIT_COPY 处理</h3><p>INIT_COPY 只是安装流程的第一步。先来看相关代码：</p>
<p>PackageManagerService.java::handleMesssage</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		doHandleMessage(msg);<span class="comment">//调用 doHandleMessage 函数</span></span><br><span class="line">	&#125; <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">            <span class="comment">//这里记录的是 params 的基类类型 HandlerParams，实际类型为 InstallParams</span></span><br><span class="line">            HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">            <span class="comment">//idx为当前等待处理的安装请求的个数</span></span><br><span class="line">            <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                <span class="comment">//APK 的安装居然需要使用另外一个 APK 提供的服务，该服务就是</span></span><br><span class="line">                <span class="comment">//DefaultContainerService，由 DefaultCotainerService.apk 提供，</span></span><br><span class="line">                <span class="comment">//下面的 connectToService 函数将调用 bindService 来启动该服务</span></span><br><span class="line">                <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                    params.serviceError();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">////如果已经连上，则以 idx 为索引，将 params 保存到 mPendingInstalls 中</span></span><br><span class="line">                    mPendingInstalls.add(idx, params);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mPendingInstalls.add(idx, params);</span><br><span class="line">                <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果安装请求队列之前的状态为空，则表明要启动安装</span></span><br><span class="line">                    mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="comment">//稍后分析</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里假设之前已经成功启动了 DefaultContainerService（以后简称 DCS），并且 idx 为零，所以这是 PKMS 首次处理安装请求，也就是说，下一个将要处理的是 MCS_BOUND 消息。</p>
<h3 id="MCS-BOUND-处理"><a href="#MCS-BOUND-处理" class="headerlink" title="MCS_BOUND 处理"></a>MCS_BOUND 处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                    <span class="comment">//如果没法启动该 service，则不能安装程序</span></span><br><span class="line">                    mPendingInstalls.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                HandlerParams params = mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//调用 params 对象的 startCopy 函数，该函数由基类 HandlerParams 定义</span></span><br><span class="line">                    <span class="keyword">if</span> (params.startCopy()) &#123;</span><br><span class="line">                        <span class="comment">//...</span></span><br><span class="line">                        <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            mPendingInstalls.remove(<span class="number">0</span>);<span class="comment">//删除队列头</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                                <span class="comment">//如果安装请求都处理完了，则需要和 Service 断绝联系,</span></span><br><span class="line">                                <span class="comment">//通过发送 MSC_UNB 消息处理断交请求</span></span><br><span class="line">                                removeMessages(MCS_UNBIND);</span><br><span class="line">                                Message ubmsg = obtainMessage(MCS_UNBIND);</span><br><span class="line">                                sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//如果还有未处理的请求，则继续发送 MCS_BOUND 消息。</span></span><br><span class="line">                            <span class="comment">//为什么不通过一个循环来处理所有请求呢</span></span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MCS_BOUND 的处理还算简单，就是调用 HandlerParams 的 startCopy 函数。</p>
<p>PackageManagerService.java::HandlerParams.startCopy()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	booleanres;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//MAX_RETIRES 目前为 4，表示尝试 4 次安装，如果还不成功，则认为安装失败</span></span><br><span class="line">		<span class="keyword">if</span>(++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">			mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">			handleServiceError();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			handleStartCopy();<span class="comment">//调用派生类的 handleStartCopy 函数</span></span><br><span class="line">			res= <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; ...</span><br><span class="line"></span><br><span class="line">	handleReturnCode();<span class="comment">//调用派生类的 handleReturnCode，返回处理结果</span></span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述代码中，基类的 startCopy 将调用子类实现的 handleStartCopy 和 handleReturnCode 函数。下面来看 InstallParams 是如何实现这两个函数的。</p>
<h3 id="InstallParams-分析"><a href="#InstallParams-分析" class="headerlink" title="InstallParams 分析"></a>InstallParams 分析</h3><p>PackageManagerService::InstallParams.handleStartCopy()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> throwsRemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> fwdLocked = (flags &amp;PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据 adb install 的参数，判断安装位置</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> onSd = (flags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> onInt = (flags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	PackageInfoLite pkgLite = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(onInt &amp;&amp; onSd) &#123;</span><br><span class="line">		<span class="comment">//APK 不能同时安装在内部存储和 SD 卡上</span></span><br><span class="line">		ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (fwdLocked &amp;&amp; onSd) &#123;</span><br><span class="line">		<span class="comment">//fwdLocked 的应用不能安装在 SD 卡上</span></span><br><span class="line">		ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">long</span> lowThreshold;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//获取 DeviceStorageMonitorService 的 binder 客户端</span></span><br><span class="line">		<span class="keyword">final</span> DeviceStorageMonitorService dsm = </span><br><span class="line">					(DeviceStorageMonitorService) ServiceManager.getService(</span><br><span class="line">					DeviceStorageMonitorService.SERVICE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(dsm == <span class="keyword">null</span>) &#123;</span><br><span class="line">			lowThreshold = <span class="number">0L</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//从 DSMS 查询内部空间最小余量，默认是总空间的10%</span></span><br><span class="line">			lowThreshold = dsm.getMemoryLowThreshold();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//授权 DefContainerService URI 读权限</span></span><br><span class="line">			mContext.grantUriPermission(DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">						packageURI,Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">	</span><br><span class="line">			<span class="comment">//调用 DCS 的 getMinimalPackageInfo 函数，得到一个 PackageLite 对象，详见下面分析</span></span><br><span class="line">			pkgLite = mContainerService.getMinimalPackageInfo(packageURI, flags,lowThreshold);</span><br><span class="line"></span><br><span class="line">		&#125;<span class="keyword">finally</span> <span class="comment">//...//撤销 URI 授权</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//PacakgeLite 的 recommendedInstallLocation 成员变量保存该 APK 推荐的安装路径</span></span><br><span class="line">		<span class="keyword">int</span> loc = pkgLite.recommendedInstallLocation;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">			ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>...&#123;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//根据 DCS 返回的安装路径，还需要调用 installLocationPolicy 进行检查</span></span><br><span class="line">			loc = installLocationPolicy(pkgLite, flags);</span><br><span class="line">	</span><br><span class="line">			<span class="keyword">if</span>(!onSd &amp;&amp; !onInt) &#123;</span><br><span class="line">				<span class="keyword">if</span>(loc == PackageHelper.RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">					flags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">					flags &amp;=~PackageManager.INSTALL_INTERNAL;</span><br><span class="line">	</span><br><span class="line">				&#125; <span class="comment">//...//处理安装位置为内部存储的情况</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建一个安装参数对象，对于安装位置为内部存储的情况，args 的真实类型为 FileInstallArgs</span></span><br><span class="line">	<span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	mArgs = args;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> requiredUid = mRequiredVerifierPackage == <span class="keyword">null</span> ? -<span class="number">1</span> : getPackageUid(mRequiredVerifierPackage);</span><br><span class="line">		<span class="keyword">if</span>(requiredUid != -<span class="number">1</span> &amp;&amp; isVerificationEnabled()) &#123;</span><br><span class="line">			<span class="comment">//...//verification 的处理，这部分代码后续再介绍</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//调用 args 的 copyApk 函数</span></span><br><span class="line">			ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	mRet = ret;<span class="comment">//确定返回值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在以上代码中，一共列出了五个关键点，总结如下：</p>
<ul>
<li>调用 DCS 的 getMinimalPackageInfo 函数，将得到一个 PackageLite 对象，该对象是一个轻量级的用于描述 APK 的结构（相比PackageParser.Package 来说）。在这段代码逻辑中，主要想取得其 recommendedInstallLocation 的值。此值表示该 APK 推荐的安装路径。</li>
<li>调用 installLocationPolicy 检查推荐的安装路径。例如：系统 Package 不允许安装在 SD 卡上。</li>
<li>createInstallArgs 将根据安装位置创建不同的 InstallArgs。如果是内部存储，则返回 FileInstallArgs，否则为 SdInstallArgs。</li>
<li>在正式安装前，应先对该 APK 进行必要的检查。这部分代码后续再介绍。</li>
<li>调用 InstallArgs 的 copyApk。对本例来说，将调用 FileInstallArgs 的 copyApk 函数。</li>
</ul>
<h3 id="DefaultContainerService-分析"><a href="#DefaultContainerService-分析" class="headerlink" title="DefaultContainerService 分析"></a>DefaultContainerService 分析</h3><p>DefaultContainerService.java::getMinimalPackageInfo()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageInfoLite <span class="title">getMinimalPackageInfo</span><span class="params">(finalUri fileUri, <span class="keyword">int</span> flags, longthreshold)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//注意该函数的参数：fileUri 指向该 APK 的文件路径（此时还在 /data/local/tmp 下）</span></span><br><span class="line">	PackageInfoLite ret = <span class="keyword">new</span> PackageInfoLite();</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	String scheme = fileUri.getScheme();</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	String archiveFilePath = fileUri.getPath();</span><br><span class="line">	DisplayMetrics metrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">	metrics.setToDefaults();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用 PackageParser 的 parsePackageLite 解析该 APK 文件</span></span><br><span class="line"> 	PackageParser.PackageLite pkg =</span><br><span class="line">			PackageParser.parsePackageLite(archiveFilePath,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;<span class="comment">//解析失败</span></span><br><span class="line">		<span class="comment">//...//设置错误值</span></span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret.packageName = pkg.packageName;</span><br><span class="line">	ret.installLocation = pkg.installLocation;</span><br><span class="line">	ret.verifiers = pkg.verifiers;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用 recommendAppInstallLocation，取得一个合理的安装位置</span></span><br><span class="line">	ret.recommendedInstallLocation =</span><br><span class="line"></span><br><span class="line">	recommendAppInstallLocation(pkg.installLocation,archiveFilePath,</span><br><span class="line">	           flags, threshold);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>APK 可在 AndroidManifest.xml 中声明一个安装位置，不过 DCS 除了解析该位置外，还需要做进一步检查，这个工作由 recommendAppInstallLocation 函数完成，代码如下：</p>
<p>DefaultContainerService.java::recommendAppInstallLocation()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">recommendAppInstallLocation</span><span class="params">(intinstallLocation, </span></span></span><br><span class="line"><span class="function"><span class="params">				StringarchiveFilePath, <span class="keyword">int</span> flags,<span class="keyword">long</span> threshold)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> prefer;</span><br><span class="line">	<span class="keyword">boolean</span> checkBoth = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	check_inner: &#123;</span><br><span class="line">		<span class="keyword">if</span>((flags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">			prefer = PREFER_INTERNAL;</span><br><span class="line">			<span class="keyword">break</span> check_inner; <span class="comment">//根据 FOWRAD_LOCK 的情况，只能安装在内部存储</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">			prefer = PREFER_INTERNAL;</span><br><span class="line">			<span class="keyword">break</span> check_inner;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...//检查各种情况</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(installLocation == PackageInfo.INSTALL_LOCATION_AUTO) &#123;</span><br><span class="line">			prefer= PREFER_INTERNAL;<span class="comment">//一般设定的位置为 AUTO，默认是内部空间</span></span><br><span class="line">			checkBoth = <span class="keyword">true</span>; <span class="comment">//设置checkBoth为true</span></span><br><span class="line">			breakcheck_inner;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//查询 settings 数据库中的 secure 表，获取用户设置的安装路径</span></span><br><span class="line">		intinstallPreference =</span><br><span class="line">				Settings.System.getInt(getApplicationContext()</span><br><span class="line">				.getContentResolver(),</span><br><span class="line">		</span><br><span class="line">		Settings.Secure.DEFAULT_INSTALL_LOCATION,</span><br><span class="line">		PackageHelper.APP_INSTALL_AUTO);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(installPreference == PackageHelper.APP_INSTALL_INTERNAL) &#123;</span><br><span class="line">			prefer = PREFER_INTERNAL;</span><br><span class="line">			<span class="keyword">break</span> check_inner;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span>(installPreference == PackageHelper.APP_INSTALL_EXTERNAL) &#123;</span><br><span class="line">			prefer = PREFER_EXTERNAL;</span><br><span class="line">			breakcheck_inner;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		prefer =PREFER_INTERNAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断外部存储空间是否为模拟的，这部分内容我们以后再介绍</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> emulated = Environment.isExternalStorageEmulated();</span><br><span class="line">	<span class="keyword">final</span> FileapkFile = <span class="keyword">new</span> File(archiveFilePath);</span><br><span class="line">	<span class="keyword">boolean</span> fitsOnInternal = <span class="keyword">false</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(checkBoth || prefer == PREFER_INTERNAL) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;<span class="comment">//检查内部存储空间是否足够大</span></span><br><span class="line">			fitsOnInternal = isUnderInternalThreshold(apkFile, threshold);</span><br><span class="line">		&#125; <span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> fitsOnSd = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">if</span>(!emulated &amp;&amp; (checkBoth || prefer == PREFER_EXTERNAL)) &#123;</span><br><span class="line">		<span class="keyword">try</span>&#123; <span class="comment">//检查外部存储空间是否足够大</span></span><br><span class="line">			fitsOnSd = isUnderExternalThreshold(apkFile);</span><br><span class="line">		&#125; <span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (prefer== PREFER_INTERNAL) &#123;</span><br><span class="line">		<span class="keyword">if</span>(fitsOnInternal) &#123;<span class="comment">//返回推荐安装路径为内部空间</span></span><br><span class="line">			<span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!emulated &amp;&amp; prefer == PREFER_EXTERNAL) &#123;</span><br><span class="line">		<span class="keyword">if</span>(fitsOnSd) &#123;<span class="comment">//返回推荐安装路径为外部空间</span></span><br><span class="line">			returnPackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(checkBoth) &#123;</span><br><span class="line">		<span class="keyword">if</span>(fitsOnInternal) &#123;<span class="comment">//如果内部存储满足条件，先返回内部空间</span></span><br><span class="line">			<span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span> (!emulated &amp;&amp; fitsOnSd) &#123;</span><br><span class="line">			<span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//... //到此，前几个条件都不满足，此处将根据情况返回一个明确的错误值</span></span><br><span class="line">	<span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DCS 的 getMinimalPackageInfo 函数为了得到一个推荐的安装路径做了不少工作，其中，各种安装策略交叉影响。这里总结一下相关的知识点：</p>
<ul>
<li>APK 在 AndroidManifest.xml 中设置的安装点默认为 AUTO，在具体对应时倾向内部空间。</li>
<li>用户在 Settings 数据库中设置的安装位置。</li>
<li>检查外部存储或内部存储是否有足够空间。</li>
</ul>
<h3 id="InstallArgs-的-copyApk-函数分析"><a href="#InstallArgs-的-copyApk-函数分析" class="headerlink" title="InstallArgs 的 copyApk 函数分析"></a>InstallArgs 的 copyApk 函数分析</h3><p>至此，我们已经得到了一个合适的安装位置，下一步工作就由 copyApk 来完成。</p>
<p>PackageManagerService.java::InstallArgs.copyApk()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copyApk</span><span class="params">(IMediaContainerService imcs, booleantemp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (temp) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            本例中temp参数为true，createCopyFile将在/data/app下创建一个临时文件。</span></span><br><span class="line"><span class="comment">            临时文件名为vmdl-随机数.tmp。为什么会用这样的文件名呢？</span></span><br><span class="line"><span class="comment">            因为PKMS通过Linux的inotify机制监控了/data/app,目录，如果新复制生成的文件名后缀</span></span><br><span class="line"><span class="comment">            为apk，将触发PKMS扫描。为了防止发生这种情况，这里复制生成的文件才有了</span></span><br><span class="line"><span class="comment">            如此奇怪的名字</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        createCopyFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FilecodeFile = <span class="keyword">new</span> File(codeFileName);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    ParcelFileDescriptor out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        out = ParcelFileDescriptor.open(codeFile, ParcelFileDescriptor.MODE_READ_WRITE);</span><br><span class="line">    &#125;<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mContext.grantUriPermission(DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">                                    packageURI, Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">        <span class="comment">//调用 DCS 的 copyResource，该函数将执行复制操作，最终结果是 /data/local/tmp</span></span><br><span class="line">        <span class="comment">//下的APK文件被复制到 /data/app 下，文件名也被换成 vmdl-随机数.tmp</span></span><br><span class="line">        ret = imcs.copyResource(packageURI, out);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//...//关闭 out，撤销 URI 授权</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="handleReturnCode-分析"><a href="#handleReturnCode-分析" class="headerlink" title="handleReturnCode 分析"></a>handleReturnCode 分析</h3><p>在 HandlerParams 的 startCopy 函数中，handleStartCopy 执行完之后，将调用 handleReturnCode 开展后续工作，代码如下：</p>
<p>PackageManagerService.java::InstallParams.HandleParams()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleReturnCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//调用processPendingInstall函数，mArgs指向之前创建的FileInstallArgs对象</span></span><br><span class="line">        processPendingInstall(mArgs, mRet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(finalInstallArgs args, <span class="keyword">final</span> intcurrentStatus)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//向 mHandler 中抛一个 Runnable 对象</span></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mHandler.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//创建一个 PackageInstalledInfo 对象，</span></span><br><span class="line">            PackageInstalledInfo res = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">            res.returnCode = currentStatus;</span><br><span class="line">            res.uid = -<span class="number">1</span>;</span><br><span class="line">            res.pkg = <span class="keyword">null</span>;</span><br><span class="line">            res.removedInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">//调用 FileInstallArgs 的 doPreInstall</span></span><br><span class="line">                args.doPreInstall(res.returnCode);</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">//调用 installPackageLI 进行安装</span></span><br><span class="line">                    installPackageLI(args, <span class="keyword">true</span>, res);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//调用 FileInstallArgs 的 doPostInstall</span></span><br><span class="line">                args.doPostInstall(res.returnCode);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> update = res.removedInfo.removedPackage != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> doRestore = (!update &amp;&amp; res.pkg != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    res.pkg.applicationInfo.backupAgentName != <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> token;<span class="comment">//计算一个ID号</span></span><br><span class="line">            <span class="keyword">if</span> (mNextInstallToken &lt; <span class="number">0</span>) mNextInstallToken = <span class="number">1</span>;</span><br><span class="line">            token = mNextInstallToken++;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//创建一个 PostInstallData 对象</span></span><br><span class="line">            PostInstallData data = <span class="keyword">new</span> PostInstallData(args, res);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//保存到 mRunningInstalls 结构中，以 token 为 key</span></span><br><span class="line">            mRunningInstalls.put(token, data);</span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore)&#123;</span><br><span class="line">             <span class="comment">//...//备份恢复的情况暂时不考虑</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                <span class="comment">//抛一个 POST_INSTALL 消息给 mHandler 进行处理</span></span><br><span class="line">                Message msg = mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面代码可知，handleReturnCode 主要做了 4 件事情：</p>
<ul>
<li>调用 InstallArgs 的 doPreInstall 函数，在本例中是 FileInstallArgs 的 doPreInstall 函数。</li>
<li>调用 PKMS 的 installPackageLI 函数进行 APK 安装，该函数内部将调用 InstallArgs的doRename 对临时文件进行改名。另外，还需要扫描此 APK 文件。此过程和之前介绍的“扫描系统 Package”一节的内容类似。至此，该 APK 中的私有财产就全部被登记到 PKMS 内部进行保存了。</li>
<li>调用 InstallArgs 的 doPostInstall 函数，在本例中是 FileInstallArgs 的 doPostInstall 函数。</li>
<li>此时，该 APK 已经安装完成（不论失败还是成功），继续向 mHandler 抛送一个 POST_INSTALL 消息，该消息携带一个 token，通过它可从 mRunningInstalls 数组中取得一个 PostInstallData 对象。</li>
</ul>
<p>这里介绍一下 FileInstallArgs 的 doRename 函数，它的功能是将临时文件改名，最终的文件的名称一般为“包名-数字.apk”。其中，数字是一个 index，从 1 开始。</p>
<h3 id="POST-INSTALL-处理"><a href="#POST-INSTALL-处理" class="headerlink" title="POST_INSTALL 处理"></a>POST_INSTALL 处理</h3><p>PackageManagerService.java::doHandleMessage()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> POST_INSTALL: &#123;</span><br><span class="line">            PostInstallData data = mRunningInstalls.get(msg.arg1);</span><br><span class="line">            mRunningInstalls.delete(msg.arg1);</span><br><span class="line">            <span class="keyword">boolean</span> deleteOld = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">                InstallArgs args = data.args;</span><br><span class="line">                PackageInstalledInfo res = data.res;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String packageName = res.pkg.applicationInfo.packageName;</span><br><span class="line">                    res.removedInfo.sendBroadcast(<span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                    Bundle extras = <span class="keyword">new</span> Bundle(<span class="number">1</span>);</span><br><span class="line">                    extras.putInt(Intent.EXTRA_UID, res.uid);</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> update = res.removedInfo.removedPackage != <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (update) &#123;</span><br><span class="line">                        extras.putBoolean(Intent.EXTRA_REPLACING, <span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//发送 PACKAGE_ADDED 广播</span></span><br><span class="line">                    sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED,</span><br><span class="line">                                         packageName, extras, <span class="keyword">null</span>, <span class="keyword">null</span>, updateUsers);</span><br><span class="line">                    <span class="keyword">if</span> (update) &#123;</span><br><span class="line">                        <span class="comment">//如果是 APK 升级，那么发送 PACKAGE_REPLACE 和 MY_PACKAGE_REPLACED 广播</span></span><br><span class="line">                        <span class="comment">//二者不同之处在于 PACKAGE_REPLACE 将携带一个 extra 信息</span></span><br><span class="line">                        <span class="comment">//...</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//...</span></span><br><span class="line">                &#125;</span><br><span class="line">                Runtime.getRuntime().gc();</span><br><span class="line">                <span class="keyword">if</span> (deleteOld) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                        <span class="comment">//调用 FileInstallArgs 的 doPostDeleteLI 进行资源清理</span></span><br><span class="line">                        res.removedInfo.args.doPostDeleteLI(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (args.observer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 向 pm 通知安装的结果</span></span><br><span class="line">                        Bundle extras = extrasForInstallResult(res);</span><br><span class="line">                        args.observer.onPackageInstalled(res.name, res.returnCode,</span><br><span class="line">                                                         res.returnMsg, extras);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Observer no longer exists."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Bogus post-install token "</span> + msg.arg1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Apk-安装流程总结"><a href="#Apk-安装流程总结" class="headerlink" title="Apk 安装流程总结"></a>Apk 安装流程总结</h3><p><img src="https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/blob/master/resources/images/android_pkms/08.png?raw=true" alt=""></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://blog.csdn.net/innost/article/details/47253179" target="_blank" rel="noopener">深入理解 PackagerManagerService</a></li>
<li><a href="http://gityuan.com/2016/11/06/packagemanager/" target="_blank" rel="noopener">PackageManager 启动篇</a></li>
</ul>


                                    <!-- Tags Bottom -->
                                    
                                        <div class="tags-container-bottom">
                                            <i class="fa fa-tag pr3 text-main-color"></i>
                                            <a class="fw3 ph1 dib" href="/tags/Android/">#Android</a> <a class="fw3 ph1 dib" href="/tags/源码分析/">#源码分析</a> <a class="fw3 ph1 dib" href="/tags/PackageMangerService/">#PackageMangerService</a> <a class="fw3 ph1 dib" href="/tags/PKMS/">#PKMS</a> <a class="fw3 ph1 dib" href="/tags/工作流程/">#工作流程</a>
                                        </div>
                                        

                                            <!-- Comments -->
                                            



                    </div>
                    <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">

                        <hr class="dn-l mw4 black-50 mt5" />

                        <!-- Widget 1: About -->
                        <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="https://avatars2.githubusercontent.com/u/5093954?s=460&v=4" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="曹建波（@jeanboy）">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            嗨，我是曹建波（@jeanboy），一名来自中国的 Android / iOS / 前端 开发者。<br/><br/>现居北京，专注于移动应用开发，热爱开源，热爱分享。
        </div>
    </article>
</div>

                            <hr class="dn-l mw4 black-50 mt5" />

                            <!-- Widget 2: Categories -->
                            
                                <div class="mt5 tc tl-l">
    <h3>分类</h3>
    
        <p>
            <a href="/categories/Android/">Android</a>
        </p>
    
</div>


                                    <hr class="dn-l mw4 black-50 mt5" />
                                    

                                        <!-- Widget 3: Recent Posts -->
                                        <div class="mt5 tc tl-l">
    <h3>近期文章</h3>
    
        <p>
            <a href="/2018/07/17/android-pkms/">一篇文章看明白 Android PackageManagerService 工作流程</a>
        </p>
    
        <p>
            <a href="/2018/07/06/jvm-memory/">Java 虚拟机内存分配机制</a>
        </p>
    
        <p>
            <a href="/2018/06/16/jvm-gc/">Java 虚拟机垃圾回收机制</a>
        </p>
    
        <p>
            <a href="/2018/05/22/internet-http-https/">一篇文章看明白 HTTP，HTTPS，SSL/TSL 之间的关系</a>
        </p>
    
        <p>
            <a href="/2018/05/05/internet-tcp-ip/">一篇文章看明白 TCP/IP，TCP，UDP，IP，Socket 之间的关系</a>
        </p>
    
</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Gitment评论插件通用代码 -->
        <div id="git"></div>
        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
        <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
        <script>
            var gitment = new Gitment({
                owner: "jeanboydev", //github用户名
                repo: "jeanboydev.github.io", //用户存储评论的github项目名称
                oauth: {
                    client_id: "a2b3dfe9ec1ec5e1578d", //注册OAuth Application时生产的ClinetID
                    client_secret: "60b7581bdfe036350e9755721059fb7c4699ff39", //注册OAuth Application时生成的Client Secret
                },
            })
            gitment.render('git')
        </script>
        <!-- Gitment代码结束 -->
    </div>

<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv5 bg-2">
    <div class="mv8">
        <div class="center tc">
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="https://github.com/jeanboydev" target="_blank">
                        <i class="fa fa-github"></i>
                    </a>
                </div>
                
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="mailto:jeanboy@foxmail.com" target="_blank">
                        <i class="fa fa-envelope"></i>
                    </a>
                </div>
                
        </div>
        <div class="f6 f5-ns center tc white pt5 fw3">
            ©2018 Jeanboy All Rights Reserved | Design & Hexo
        </div>
    </div>
</div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>